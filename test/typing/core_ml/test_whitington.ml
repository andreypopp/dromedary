open! Import
open Util

(* Examples taken from http://komar.in/files/mlbook.pdf *)

let%expect_test "" =
  let str = 
    {|
      let _ = 1 + 2 * 3;;

      let _ = 5 * -2;;

      let _ = true;;

      let _ = false;;

      let _ = 4 + 3 + 2 + 1 = 10;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: int
                                  └──Desc: Primitive: (+)
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 1
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: int
                                        └──Desc: Primitive: (*)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 2
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 3
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: int
                                  └──Desc: Primitive: (*)
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 5
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: -2
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Constant: true
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Constant: false
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: bool
                                  └──Desc: Primitive: (=)
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Primitive: (+)
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (+)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Constant: 4
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 3
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 10 |}]

let%expect_test "" =
  let str = 
    {|
      let _ = 1 + true;;
    |}
  in
  print_infer_result str;
  [%expect {|
    ("Cannot unify types"
     ("Type_expr.decode type_expr1" (Type 144 (Former (Constr () int))))
     ("Type_expr.decode type_expr2" (Type 162 (Former (Constr () bool))))) |}]

let%expect_test "" =
  let str = 
    {|
      let _ = if 100 = 99 then 0 else 1;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: If
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: bool
                                        └──Desc: Primitive: (=)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 100
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 99
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 1 |}]

let%expect_test "" =
  let str = 
    {|
      let x = 200;;

      let _ = x * x * x;;

      let _ = 
        let y = 200 in 
        y * y * 2
      ;;

      let cube = fun x -> x * x * x;;

      let _ = cube 200;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Variable: x
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Constant: 200
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: int
                                  └──Desc: Primitive: (*)
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (*)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: x
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Let
                         └──Value bindings:
                            └──Value binding:
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: y
                               └──Abstraction:
                                  └──Variables:
                                  └──Expression:
                                     └──Type expr: Constructor: int
                                     └──Desc: Constant: 200
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: int
                                        └──Desc: Primitive: (*)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (*)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: y
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: y
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 2
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Variable: cube
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: int
                                        └──Desc: Primitive: (*)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (*)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: cube
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 200 |}]

let%expect_test "" =
  let str = 
    {|
      let cube = fun x -> x * x * x;;

      let _ = cube false;;
    |}
  in
  print_infer_result str;
  [%expect {|
    ("Cannot unify types"
     ("Type_expr.decode type_expr1" (Type 354 (Former (Constr () int))))
     ("Type_expr.decode type_expr2" (Type 360 (Former (Constr () bool))))) |}]

let%expect_test "" =
  let str = 
    {|
      external lt : 'a. 'a -> 'a -> bool = "%less_than";;

      let neg = fun x -> if lt x 0 then true else false;;

      let _ = neg (-30);;

      let neg = fun x -> lt x 0;;

      let _ = neg (-20);;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 362
                └──Type expr: Arrow
                   └──Type expr: Variable: 362
                   └──Type expr: Arrow
                      └──Type expr: Variable: 362
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: neg
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: If
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: bool
                                              └──Desc: Variable
                                                 └──Variable: lt
                                                 └──Type expr: Constructor: int
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Constant: true
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Constant: false
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: bool
                            └──Desc: Variable
                               └──Variable: neg
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: -30
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: neg
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: bool
                                        └──Desc: Variable
                                           └──Variable: lt
                                           └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: bool
                            └──Desc: Variable
                               └──Variable: neg
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: -20 |}]

let%expect_test "" =
  let str = 
    {|
      let is_vowel = fun c -> 
        match c with
        ( 'a' -> true
        | 'e' -> true
        | 'i' -> true
        | 'o' -> true
        | 'u' -> true
        | _ -> false
        )
      ;;

      let _ = is_vowel 'x';;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: char
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: is_vowel
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: char
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: char
                            └──Desc: Variable: c
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: char
                                  └──Desc: Variable
                                     └──Variable: c
                               └──Type expr: Constructor: char
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: a
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: e
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: i
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: o
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: u
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: char
                                        └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: false
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: char
                               └──Type expr: Constructor: bool
                            └──Desc: Variable
                               └──Variable: is_vowel
                         └──Expression:
                            └──Type expr: Constructor: char
                            └──Desc: Constant: x |}]

let%expect_test "" =
  let str = 
    {|
      let add_to_ten = 
        fun n1 n2 -> n1 + n2 = 10
      ;;

      let _ = add_to_ten 6 4;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: bool
                   └──Desc: Variable: add_to_ten
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: n1
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: bool
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n2
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: bool
                                              └──Desc: Primitive: (=)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Primitive: (+)
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: n1
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 10
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: bool
                                  └──Desc: Variable
                                     └──Variable: add_to_ten
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 6
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 4 |}]

let%expect_test "" =
  let str = 
    {|
      let rec fact =
        fun n ->
          if n = 1 then 1 else n * fact (n - 1)
      ;;

      let _ = fact 4;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: fact
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: n
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: If
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: bool
                                              └──Desc: Primitive: (=)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: n
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 1
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (*)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: n
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: fact
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Primitive: (-)
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: n
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: fact
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 4 |}]

let%expect_test "" =
  let str = 
    {|
      external mod : int -> int -> int = "%mod";;

      let rec gcd = 
        fun m n ->
          if n = 0 then m else gcd m (mod m n)
      ;;

      let _ = gcd 64000 3546;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: mod
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
             └──Primitive name: %mod
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: gcd
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: m
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Primitive: (=)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: m
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: gcd
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: m
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: mod
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: m
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: gcd
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 64000
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 3546 |}]

let%expect_test "" =
  let str = 
    {|
      let not = 
        fun x -> if x then false else true
      ;;

      let _ = not true;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: bool
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: not
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: bool
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: bool
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: If
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Variable
                                     └──Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Constant: false
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Constant: true
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: bool
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: bool
                               └──Type expr: Constructor: bool
                            └──Desc: Variable
                               └──Variable: not
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Constant: true |}]

let%expect_test "" =
  let str = 
    {|
      let rec fact = 
        fun n ->
          match n with
          ( 1 -> 1
          | n -> n * fact (n - 1)
          )
      ;;

      external mod : int -> int -> int = "%mod";;

      let rec gcd = 
        fun m n ->
          match n with
          ( 0 -> m
          | _ -> gcd n (mod m n)
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: fact
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: n
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: n
                               └──Type expr: Constructor: int
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable: n
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (*)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: fact
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (-)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 1
       └──Structure item: Primitive
          └──Value description:
             └──Name: mod
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
             └──Primitive name: %mod
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: gcd
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: m
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: n
                                     └──Type expr: Constructor: int
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: m
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: int
                                              └──Desc: Any
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: gcd
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: n
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: mod
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: m
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: n |}]

let%expect_test "" =
  let str = 
    {|
      (* The amount of times I've written this def. I should just make a macro! *)
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      let _ = Nil;;
      let _ = Cons (5, Nil);;

      let _ = Cons (false, Cons (true, Cons (false, Nil)));;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 773
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 773
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 773
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 773
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 773
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 773
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 779
                   └──Desc: Any
                └──Abstraction:
                   └──Variables: 779
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 779
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Nil
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 779
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: int
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Cons
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 5
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Nil
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: bool
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: bool
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Cons
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: bool
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: bool
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: bool
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: bool
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: bool
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Constant: false
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: bool
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: bool
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: bool
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: bool
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: bool
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: bool
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Constant: true
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: bool
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: bool
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: bool
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: bool
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Constant: false
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: bool |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      let is_empty = 
        fun t ->
          match t with
          ( Nil -> true
          | _ -> false
          )
      ;;

      let rec length = 
        fun t ->
          match t with
          ( Nil -> 0
          | Cons (_, t) -> 1 + length t
          )
      ;;

      let rec sum = 
        fun t ->
          match t with
          ( Nil -> 0
          | Cons (x, t) -> x + sum t
          )
      ;;

      let length = fun t ->
        let rec loop =
          fun t acc ->
            match t with
            ( Nil -> acc
            | Cons (_, t) -> loop t (1 + acc)
            )
        in loop t 0
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 842
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 842
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 842
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 842
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 842
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 842
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 853
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: is_empty
                └──Abstraction:
                   └──Variables: 853
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 853
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 853
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 853
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 853
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 853
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 853
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: true
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 853
                                        └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Constant: false
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: length
                └──Abstraction:
                   └──Variables: 871
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 871
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 871
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 871
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 871
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 871
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 871
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 871
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 871
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 871
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 871
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 871
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 871
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 871
                                                    └──Desc: Any
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 871
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 871
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: length
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 871
                                                    └──Desc: Variable
                                                       └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: sum
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: sum
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1008
                      └──Type expr: Constructor: int
                   └──Desc: Variable: length
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1008
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1008
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Let rec
                               └──Value bindings:
                                  └──Value binding:
                                     └──Variable: loop
                                     └──Abstraction:
                                        └──Variables: 964
                                        └──Expression:
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 964
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                           └──Desc: Function
                                              └──Pattern:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 964
                                                 └──Desc: Variable: t
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                                 └──Desc: Function
                                                    └──Pattern:
                                                       └──Type expr: Constructor: int
                                                       └──Desc: Variable: acc
                                                    └──Expression:
                                                       └──Type expr: Constructor: int
                                                       └──Desc: Match
                                                          └──Expression:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 964
                                                             └──Desc: Variable
                                                                └──Variable: t
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 964
                                                          └──Cases:
                                                             └──Case:
                                                                └──Pattern:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 964
                                                                   └──Desc: Construct
                                                                      └──Constructor description:
                                                                         └──Name: Nil
                                                                         └──Constructor type:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 964
                                                                └──Expression:
                                                                   └──Type expr: Constructor: int
                                                                   └──Desc: Variable
                                                                      └──Variable: acc
                                                             └──Case:
                                                                └──Pattern:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 964
                                                                   └──Desc: Construct
                                                                      └──Constructor description:
                                                                         └──Name: Cons
                                                                         └──Constructor argument type:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 964
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 964
                                                                         └──Constructor type:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 964
                                                                      └──Pattern:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 964
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 964
                                                                         └──Desc: Tuple
                                                                            └──Pattern:
                                                                               └──Type expr: Variable: 964
                                                                               └──Desc: Any
                                                                            └──Pattern:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 964
                                                                               └──Desc: Variable: t
                                                                └──Expression:
                                                                   └──Type expr: Constructor: int
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: int
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 964
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Constructor: int
                                                                               └──Desc: Variable
                                                                                  └──Variable: loop
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 964
                                                                               └──Desc: Variable
                                                                                  └──Variable: t
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: int
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: int
                                                                               └──Desc: Application
                                                                                  └──Expression:
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: int
                                                                                     └──Desc: Primitive: (+)
                                                                                  └──Expression:
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Desc: Constant: 1
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: int
                                                                               └──Desc: Variable
                                                                                  └──Variable: acc
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1008
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: loop
                                                 └──Type expr: Variable: 1008
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1008
                                              └──Desc: Variable
                                                 └──Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec odd_elements = 
        fun t ->
          match t with
          ( Nil -> Nil
          | Cons (x, Nil) -> Cons (x, Nil)
          | Cons (x, Cons (_, t)) -> Cons (x, odd_elements t)
          )
      ;;

      let rec odd_elements = 
        fun t ->
          match t with
          ( Cons (x, Cons (_, t)) -> Cons (x, odd_elements t)
          | t -> t
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1013
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1013
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1013
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1013
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1013
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1013
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: odd_elements
                └──Abstraction:
                   └──Variables: 1080
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1080
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1080
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1080
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1080
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1080
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1080
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1080
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1080
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 1080
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1080
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1080
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Variable: 1080
                                                    └──Desc: Variable
                                                       └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1080
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1080
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 1080
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1080
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1080
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1080
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1080
                                                                └──Desc: Any
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1080
                                                                └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1080
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1080
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1080
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1080
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Variable: 1080
                                                    └──Desc: Variable
                                                       └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1080
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1080
                                                          └──Desc: Variable
                                                             └──Variable: odd_elements
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1080
                                                          └──Desc: Variable
                                                             └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: odd_elements
                └──Abstraction:
                   └──Variables: 1123
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1123
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1123
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1123
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1123
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1123
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1123
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1123
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1123
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1123
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1123
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1123
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1123
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 1123
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1123
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1123
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1123
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1123
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1123
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1123
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1123
                                                                └──Desc: Any
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1123
                                                                └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1123
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1123
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1123
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1123
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1123
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1123
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Variable: 1123
                                                    └──Desc: Variable
                                                       └──Variable: x
                                                       └──Type expr: Variable: 1123
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1123
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1123
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1123
                                                          └──Desc: Variable
                                                             └──Variable: odd_elements
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1123
                                                          └──Desc: Variable
                                                             └──Variable: t
                                                             └──Type expr: Variable: 1123
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1123
                                        └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1123
                                        └──Desc: Variable
                                           └──Variable: t |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec append = 
        fun t1 t2 ->
          match t1 with
          ( Nil -> t2
          | Cons (x, t1) -> Cons (x, append t1 t2)
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1140
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1140
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1140
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1140
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1140
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1140
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: append
                └──Abstraction:
                   └──Variables: 1169
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1169
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1169
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1169
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1169
                            └──Desc: Variable: t1
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1169
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1169
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1169
                                  └──Desc: Variable: t2
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1169
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1169
                                        └──Desc: Variable
                                           └──Variable: t1
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 1169
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1169
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1169
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1169
                                              └──Desc: Variable
                                                 └──Variable: t2
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1169
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1169
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1169
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1169
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1169
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1169
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 1169
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1169
                                                          └──Desc: Variable: t1
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1169
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1169
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1169
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1169
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1169
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1169
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 1169
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1169
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1169
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1169
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1169
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1169
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1169
                                                                      └──Desc: Variable
                                                                         └──Variable: append
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1169
                                                                      └──Desc: Variable
                                                                         └──Variable: t1
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1169
                                                                └──Desc: Variable
                                                                   └──Variable: t2 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      (* Non tail-recursive impl *)

      let rec append = 
        fun t1 t2 ->
          match t1 with
          ( Nil -> t2
          | Cons (x, t1) -> Cons (x, append t1 t2)
          )
      ;;

      let rec rev = 
        fun t ->
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> append (rev t) (Cons (x, Nil)) 
          )
      ;;

      (* tail-recursive impl *)

      let rev = fun t -> 
        let rec loop = 
          fun t acc ->
            match t with
            ( Nil -> acc
            | Cons (x, t) -> loop t (Cons (x, acc))
            )
        in
        loop t Nil
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1187
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1187
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1187
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1187
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1187
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1187
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: append
                └──Abstraction:
                   └──Variables: 1216
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1216
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1216
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1216
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1216
                            └──Desc: Variable: t1
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1216
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1216
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1216
                                  └──Desc: Variable: t2
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1216
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1216
                                        └──Desc: Variable
                                           └──Variable: t1
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 1216
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1216
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1216
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1216
                                              └──Desc: Variable
                                                 └──Variable: t2
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1216
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1216
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1216
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1216
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1216
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1216
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 1216
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1216
                                                          └──Desc: Variable: t1
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1216
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1216
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1216
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1216
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1216
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1216
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 1216
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1216
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1216
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1216
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1216
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1216
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1216
                                                                      └──Desc: Variable
                                                                         └──Variable: append
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1216
                                                                      └──Desc: Variable
                                                                         └──Variable: t1
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1216
                                                                └──Desc: Variable
                                                                   └──Variable: t2
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: rev
                └──Abstraction:
                   └──Variables: 1283
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1283
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1283
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1283
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1283
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1283
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1283
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1283
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1283
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1283
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1283
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1283
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1283
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 1283
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1283
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1283
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1283
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1283
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1283
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1283
                                                    └──Desc: Variable
                                                       └──Variable: append
                                                       └──Type expr: Variable: 1283
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1283
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1283
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1283
                                                          └──Desc: Variable
                                                             └──Variable: rev
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1283
                                                          └──Desc: Variable
                                                             └──Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1283
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1283
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1283
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1283
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1283
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1283
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 1283
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1283
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1283
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1344
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1344
                   └──Desc: Variable: rev
                └──Abstraction:
                   └──Variables: 1344,1344
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1344
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1344
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1344
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1344
                            └──Desc: Let rec
                               └──Value bindings:
                                  └──Value binding:
                                     └──Variable: loop
                                     └──Abstraction:
                                        └──Variables: 1322
                                        └──Expression:
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1322
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1322
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1322
                                           └──Desc: Function
                                              └──Pattern:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1322
                                                 └──Desc: Variable: t
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1322
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1322
                                                 └──Desc: Function
                                                    └──Pattern:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1322
                                                       └──Desc: Variable: acc
                                                    └──Expression:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1322
                                                       └──Desc: Match
                                                          └──Expression:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1322
                                                             └──Desc: Variable
                                                                └──Variable: t
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1322
                                                          └──Cases:
                                                             └──Case:
                                                                └──Pattern:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1322
                                                                   └──Desc: Construct
                                                                      └──Constructor description:
                                                                         └──Name: Nil
                                                                         └──Constructor type:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1322
                                                                └──Expression:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1322
                                                                   └──Desc: Variable
                                                                      └──Variable: acc
                                                             └──Case:
                                                                └──Pattern:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1322
                                                                   └──Desc: Construct
                                                                      └──Constructor description:
                                                                         └──Name: Cons
                                                                         └──Constructor argument type:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 1322
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1322
                                                                         └──Constructor type:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1322
                                                                      └──Pattern:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 1322
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1322
                                                                         └──Desc: Tuple
                                                                            └──Pattern:
                                                                               └──Type expr: Variable: 1322
                                                                               └──Desc: Variable: x
                                                                            └──Pattern:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1322
                                                                               └──Desc: Variable: t
                                                                └──Expression:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1322
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1322
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1322
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1322
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1322
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1322
                                                                               └──Desc: Variable
                                                                                  └──Variable: loop
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1322
                                                                               └──Desc: Variable
                                                                                  └──Variable: t
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1322
                                                                         └──Desc: Construct
                                                                            └──Constructor description:
                                                                               └──Name: Cons
                                                                               └──Constructor argument type:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 1322
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1322
                                                                               └──Constructor type:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1322
                                                                            └──Expression:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 1322
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1322
                                                                               └──Desc: Tuple
                                                                                  └──Expression:
                                                                                     └──Type expr: Variable: 1322
                                                                                     └──Desc: Variable
                                                                                        └──Variable: x
                                                                                  └──Expression:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1322
                                                                                     └──Desc: Variable
                                                                                        └──Variable: acc
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1344
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1344
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1344
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1344
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1344
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1344
                                              └──Desc: Variable
                                                 └──Variable: loop
                                                 └──Type expr: Variable: 1344
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1344
                                              └──Desc: Variable
                                                 └──Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1344
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1344 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil 
        | Cons of 'a * 'a list
      ;;

      external failwith : 'a. string -> 'a = "%failwith";;

      let rec take = 
        fun t n ->
          if n = 0 then Nil
          else 
            match t with
            ( Nil -> failwith "Invalid argument"
            | Cons (x, t) -> Cons (x, take t (n - 1))
            )
      ;;

      let rec drop = 
        fun t n ->
          if n = 0 then t 
          else
            match t with
            ( Nil -> failwith "Invalid argument"
            | Cons (_, t) -> drop t (n - 1)
            )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1347
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1347
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1347
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1347
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1347
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1347
       └──Structure item: Primitive
          └──Value description:
             └──Name: failwith
             └──Scheme:
                └──Variables: 1352
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Variable: 1352
             └──Primitive name: %failwith
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: take
                └──Abstraction:
                   └──Variables: 1412
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1412
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1412
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1412
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1412
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1412
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Primitive: (=)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1412
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1412
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1412
                                        └──Desc: Match
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1412
                                              └──Desc: Variable
                                                 └──Variable: t
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1412
                                           └──Cases:
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1412
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1412
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                          └──Desc: Variable
                                                             └──Variable: failwith
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                       └──Expression:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Constant: Invalid argument
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1412
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1412
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1412
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1412
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1412
                                                                └──Desc: Variable: x
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1412
                                                                └──Desc: Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1412
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1412
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1412
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1412
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1412
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Variable: 1412
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1412
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1412
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1412
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1412
                                                                            └──Desc: Variable
                                                                               └──Variable: take
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1412
                                                                            └──Desc: Variable
                                                                               └──Variable: t
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Type expr: Constructor: int
                                                                                  └──Desc: Primitive: (-)
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: n
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: drop
                └──Abstraction:
                   └──Variables: 1489
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1489
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1489
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1489
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1489
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1489
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Primitive: (=)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1489
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1489
                                        └──Desc: Match
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1489
                                              └──Desc: Variable
                                                 └──Variable: t
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1489
                                           └──Cases:
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1489
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1489
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                          └──Desc: Variable
                                                             └──Variable: failwith
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                       └──Expression:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Constant: Invalid argument
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1489
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1489
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1489
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1489
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1489
                                                                └──Desc: Any
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1489
                                                                └──Desc: Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1489
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1489
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1489
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1489
                                                                └──Desc: Variable
                                                                   └──Variable: drop
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1489
                                                                └──Desc: Variable
                                                                   └──Variable: t
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (-)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: n
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 1 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      external leq : 'a. 'a -> 'a -> bool = "%less_than_equal";;

      let rec insert = 
        fun x t ->
          match t with
          ( Nil -> Cons (x, Nil)
          | Cons (y, t) ->
            if leq x y 
              then Cons (x, Cons (y, t))
              else Cons (y, insert x t) 
          )
      ;;

      let rec sort =
        fun t -> 
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> insert x (sort t)
          )
      ;;

      let _ = sort (Cons ('p', Cons ('i', Cons ('m', Cons ('c', Cons ('s', Cons ('h', Nil)))))));;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1525
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1525
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1525
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1525
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1525
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1525
       └──Structure item: Primitive
          └──Value description:
             └──Name: leq
             └──Scheme:
                └──Variables: 1530
                └──Type expr: Arrow
                   └──Type expr: Variable: 1530
                   └──Type expr: Arrow
                      └──Type expr: Variable: 1530
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than_equal
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: insert
                └──Abstraction:
                   └──Variables: 1624
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Variable: 1624
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1624
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1624
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Variable: 1624
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1624
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1624
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1624
                                  └──Desc: Variable: t
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1624
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1624
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 1624
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1624
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1624
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1624
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1624
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1624
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1624
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1624
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1624
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 1624
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1624
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 1624
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1624
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 1624
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1624
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1624
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 1624
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1624
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 1624
                                                          └──Desc: Variable: y
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1624
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1624
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 1624
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 1624
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 1624
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: leq
                                                                   └──Type expr: Variable: 1624
                                                             └──Expression:
                                                                └──Type expr: Variable: 1624
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Variable: 1624
                                                          └──Desc: Variable
                                                             └──Variable: y
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1624
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1624
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1624
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1624
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1624
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1624
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Variable: 1624
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1624
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Cons
                                                                      └──Constructor argument type:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 1624
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1624
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1624
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 1624
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1624
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 1624
                                                                            └──Desc: Variable
                                                                               └──Variable: y
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1624
                                                                            └──Desc: Variable
                                                                               └──Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1624
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1624
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1624
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1624
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1624
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1624
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Variable: 1624
                                                                └──Desc: Variable
                                                                   └──Variable: y
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1624
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1624
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1624
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 1624
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1624
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1624
                                                                            └──Desc: Variable
                                                                               └──Variable: insert
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 1624
                                                                            └──Desc: Variable
                                                                               └──Variable: x
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1624
                                                                      └──Desc: Variable
                                                                         └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: sort
                └──Abstraction:
                   └──Variables: 1637
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1637
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1637
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1637
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1637
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1637
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1637
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1637
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1637
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1637
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 1637
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1637
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 1637
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 1637
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1637
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1637
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1637
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Variable: 1637
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1637
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 1637
                                                    └──Desc: Variable
                                                       └──Variable: insert
                                                       └──Type expr: Variable: 1637
                                                 └──Expression:
                                                    └──Type expr: Variable: 1637
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1637
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1637
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 1637
                                                    └──Desc: Variable
                                                       └──Variable: sort
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1637
                                                    └──Desc: Variable
                                                       └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: char
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: char
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: char
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: char
                            └──Desc: Variable
                               └──Variable: sort
                               └──Type expr: Constructor: char
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: char
                            └──Desc: Construct
                               └──Constructor description:
                                  └──Name: Cons
                                  └──Constructor argument type:
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: char
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: char
                                  └──Constructor type:
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: char
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: char
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: char
                                  └──Desc: Tuple
                                     └──Expression:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: p
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: char
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: char
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: char
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: char
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: char
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: char
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Constructor: char
                                                    └──Desc: Constant: i
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: char
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: char
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Constructor: char
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: char
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: char
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: char
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Constructor: char
                                                                └──Desc: Constant: m
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Constructor: char
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Cons
                                                                      └──Constructor argument type:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Constructor: char
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Constructor: char
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Constructor: char
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: char
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Constructor: char
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: char
                                                                            └──Desc: Constant: c
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Constructor: char
                                                                            └──Desc: Construct
                                                                               └──Constructor description:
                                                                                  └──Name: Cons
                                                                                  └──Constructor argument type:
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Constructor: char
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Constructor: char
                                                                                  └──Constructor type:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Constructor: char
                                                                               └──Expression:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Constructor: char
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Constructor: char
                                                                                  └──Desc: Tuple
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: char
                                                                                        └──Desc: Constant: s
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Constructor: char
                                                                                        └──Desc: Construct
                                                                                           └──Constructor description:
                                                                                              └──Name: Cons
                                                                                              └──Constructor argument type:
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Constructor: char
                                                                                                    └──Type expr: Constructor: list
                                                                                                       └──Type expr: Constructor: char
                                                                                              └──Constructor type:
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Constructor: char
                                                                                           └──Expression:
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Constructor: char
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Constructor: char
                                                                                              └──Desc: Tuple
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: char
                                                                                                    └──Desc: Constant: h
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: list
                                                                                                       └──Type expr: Constructor: char
                                                                                                    └──Desc: Construct
                                                                                                       └──Constructor description:
                                                                                                          └──Name: Nil
                                                                                                          └──Constructor type:
                                                                                                             └──Type expr: Constructor: list
                                                                                                                └──Type expr: Constructor: char |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list = 
        | Nil
        | Cons of 'a * 'a list
      ;;

      external lt : 'a. 'a -> 'a -> bool = "%less_than";;
      external leq : 'a. 'a -> 'a -> bool = "%less_than_equal";;

      external take : 'a. 'a list -> int -> 'a list = "%take";;
      external drop : 'a. 'a list -> int -> 'a list = "%drop";;
      external length : 'a. 'a list -> int = "%length";;


      let rec merge = 
        fun t1 t2 ->
          match (t1, t2) with
          ( (Nil, t) -> t
          | (t, Nil) -> t
          | (Cons (x1, t1), Cons (x2, t2)) ->
              if lt x1 x2 
                then Cons (x1, merge t1 (Cons (x2, t2)) )
                else Cons (x2, merge (Cons (x1, t1)) t2 ) 
          )
      ;;


      let rec merge_sort = 
        fun t ->
          match t with
          ( Nil -> Nil
          | Cons (x, Nil) -> Cons (x, Nil)
          | _ ->
            let n = length t / 2 in
            let left = take t n in
            let right = drop t n in
            merge (merge_sort left) (merge_sort right)
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 1755
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1755
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 1755
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1755
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 1755
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1755
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 1760
                └──Type expr: Arrow
                   └──Type expr: Variable: 1760
                   └──Type expr: Arrow
                      └──Type expr: Variable: 1760
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Primitive
          └──Value description:
             └──Name: leq
             └──Scheme:
                └──Variables: 1767
                └──Type expr: Arrow
                   └──Type expr: Variable: 1767
                   └──Type expr: Arrow
                      └──Type expr: Variable: 1767
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than_equal
       └──Structure item: Primitive
          └──Value description:
             └──Name: take
             └──Scheme:
                └──Variables: 1774
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 1774
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1774
             └──Primitive name: %take
       └──Structure item: Primitive
          └──Value description:
             └──Name: drop
             └──Scheme:
                └──Variables: 1785
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 1785
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 1785
             └──Primitive name: %drop
       └──Structure item: Primitive
          └──Value description:
             └──Name: length
             └──Scheme:
                └──Variables: 1796
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 1796
                   └──Type expr: Constructor: int
             └──Primitive name: %length
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: merge
                └──Abstraction:
                   └──Variables: 1916
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 1916
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1916
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1916
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 1916
                            └──Desc: Variable: t1
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1916
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 1916
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1916
                                  └──Desc: Variable: t2
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 1916
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1916
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 1916
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1916
                                              └──Desc: Variable
                                                 └──Variable: t1
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1916
                                              └──Desc: Variable
                                                 └──Variable: t2
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1916
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 1916
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1916
                                              └──Desc: Variable
                                                 └──Variable: t
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Variable: t
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1916
                                              └──Desc: Variable
                                                 └──Variable: t
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 1916
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1916
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1916
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1916
                                                                └──Desc: Variable: x1
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                                └──Desc: Variable: t1
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1916
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1916
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 1916
                                                                └──Desc: Variable: x2
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                                └──Desc: Variable: t2
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 1916
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 1916
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 1916
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 1916
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: lt
                                                                   └──Type expr: Variable: 1916
                                                             └──Expression:
                                                                └──Type expr: Variable: 1916
                                                                └──Desc: Variable
                                                                   └──Variable: x1
                                                       └──Expression:
                                                          └──Type expr: Variable: 1916
                                                          └──Desc: Variable
                                                             └──Variable: x2
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1916
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1916
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Variable: 1916
                                                                └──Desc: Variable
                                                                   └──Variable: x1
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1916
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1916
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1916
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                            └──Desc: Variable
                                                                               └──Variable: merge
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1916
                                                                            └──Desc: Variable
                                                                               └──Variable: t1
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1916
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Cons
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 1916
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1916
                                                                         └──Expression:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 1916
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1916
                                                                            └──Desc: Tuple
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 1916
                                                                                  └──Desc: Variable
                                                                                     └──Variable: x2
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                                  └──Desc: Variable
                                                                                     └──Variable: t2
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 1916
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 1916
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 1916
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 1916
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Variable: 1916
                                                                └──Desc: Variable
                                                                   └──Variable: x2
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 1916
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1916
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 1916
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 1916
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 1916
                                                                            └──Desc: Variable
                                                                               └──Variable: merge
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 1916
                                                                            └──Desc: Construct
                                                                               └──Constructor description:
                                                                                  └──Name: Cons
                                                                                  └──Constructor argument type:
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 1916
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 1916
                                                                                  └──Constructor type:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1916
                                                                               └──Expression:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 1916
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 1916
                                                                                  └──Desc: Tuple
                                                                                     └──Expression:
                                                                                        └──Type expr: Variable: 1916
                                                                                        └──Desc: Variable
                                                                                           └──Variable: x1
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 1916
                                                                                        └──Desc: Variable
                                                                                           └──Variable: t1
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 1916
                                                                      └──Desc: Variable
                                                                         └──Variable: t2
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: merge_sort
                └──Abstraction:
                   └──Variables: 2017
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2017
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2017
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2017
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2017
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2017
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2017
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 2017
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2017
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 2017
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 2017
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2017
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2017
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 2017
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2017
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 2017
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2017
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Variable: 2017
                                                    └──Desc: Variable
                                                       └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2017
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2017
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2017
                                        └──Desc: Let
                                           └──Value bindings:
                                              └──Value binding:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable: n
                                                 └──Abstraction:
                                                    └──Variables:
                                                    └──Expression:
                                                       └──Type expr: Constructor: int
                                                       └──Desc: Application
                                                          └──Expression:
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                   └──Desc: Primitive: (/)
                                                                └──Expression:
                                                                   └──Type expr: Constructor: int
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                            └──Type expr: Constructor: int
                                                                         └──Desc: Variable
                                                                            └──Variable: length
                                                                            └──Type expr: Variable: 2017
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2017
                                                                         └──Desc: Variable
                                                                            └──Variable: t
                                                          └──Expression:
                                                             └──Type expr: Constructor: int
                                                             └──Desc: Constant: 2
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2017
                                              └──Desc: Let
                                                 └──Value bindings:
                                                    └──Value binding:
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2017
                                                          └──Desc: Variable: left
                                                       └──Abstraction:
                                                          └──Variables:
                                                          └──Expression:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2017
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2017
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2017
                                                                         └──Desc: Variable
                                                                            └──Variable: take
                                                                            └──Type expr: Variable: 2017
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2017
                                                                         └──Desc: Variable
                                                                            └──Variable: t
                                                                └──Expression:
                                                                   └──Type expr: Constructor: int
                                                                   └──Desc: Variable
                                                                      └──Variable: n
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2017
                                                    └──Desc: Let
                                                       └──Value bindings:
                                                          └──Value binding:
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 2017
                                                                └──Desc: Variable: right
                                                             └──Abstraction:
                                                                └──Variables:
                                                                └──Expression:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2017
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2017
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2017
                                                                               └──Desc: Variable
                                                                                  └──Variable: drop
                                                                                  └──Type expr: Variable: 2017
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2017
                                                                               └──Desc: Variable
                                                                                  └──Variable: t
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: int
                                                                         └──Desc: Variable
                                                                            └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2017
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2017
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2017
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2017
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                      └──Desc: Variable
                                                                         └──Variable: merge
                                                                         └──Type expr: Variable: 2017
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2017
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2017
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2017
                                                                            └──Desc: Variable
                                                                               └──Variable: merge_sort
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2017
                                                                            └──Desc: Variable
                                                                               └──Variable: left
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 2017
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2017
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2017
                                                                      └──Desc: Variable
                                                                         └──Variable: merge_sort
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2017
                                                                      └──Desc: Variable
                                                                         └──Variable: right |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec double = 
        fun t ->
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> Cons (2 * x, double t)
          )
      ;;

      external mod : int -> int -> int = "%mod";;

      let rec evens = 
        fun t ->
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> Cons (mod x 2 = 0, evens t)
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 2037
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2037
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 2037
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2037
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 2037
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2037
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: double
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (*)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 2
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: double
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: t
       └──Structure item: Primitive
          └──Value description:
             └──Name: mod
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
             └──Primitive name: %mod
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: evens
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: bool
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: bool
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: bool
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: int
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: bool
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: bool
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: bool
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: bool
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: bool
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: bool
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Primitive: (=)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: int
                                                                            └──Desc: Variable
                                                                               └──Variable: mod
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Variable
                                                                               └──Variable: x
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Constant: 2
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 0
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: bool
                                                          └──Desc: Variable
                                                             └──Variable: evens
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: t |}]


let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec map = 
        fun t f ->
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> Cons (f x, map t f)
          )
      ;;

      let halve = fun x -> x / 2;;

      let _ = map (Cons (10, Cons (20, Cons (30, Nil)))) halve;;

      external mod : int -> int -> int = "%mod";;

      let is_even = fun x -> mod x 2 = 0;;

      let evens = fun t -> map t is_even;;

      let evens = fun t -> map t (fun x -> mod x 2 = 0);;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 2177
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2177
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 2177
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2177
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 2177
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2177
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: map
                └──Abstraction:
                   └──Variables: 2209,2220
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2220
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 2220
                               └──Type expr: Variable: 2209
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2209
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2220
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 2220
                                  └──Type expr: Variable: 2209
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2209
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 2220
                                     └──Type expr: Variable: 2209
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2209
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2220
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2220
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2220
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2220
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2209
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2209
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2220
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2220
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2220
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2220
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2220
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2220
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 2220
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2220
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2209
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2209
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2209
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2209
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2209
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2209
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 2209
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 2220
                                                                   └──Type expr: Variable: 2209
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                             └──Expression:
                                                                └──Type expr: Variable: 2220
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2209
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 2220
                                                                      └──Type expr: Variable: 2209
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2209
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2220
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 2220
                                                                               └──Type expr: Variable: 2209
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2209
                                                                      └──Desc: Variable
                                                                         └──Variable: map
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2220
                                                                      └──Desc: Variable
                                                                         └──Variable: t
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 2220
                                                                   └──Type expr: Variable: 2209
                                                                └──Desc: Variable
                                                                   └──Variable: f
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Variable: halve
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: int
                                        └──Desc: Primitive: (/)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 2
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: map
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: int
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 10
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: int
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: int
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 20
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: int
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: int
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Constant: 30
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Nil
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: int
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: halve
       └──Structure item: Primitive
          └──Value description:
             └──Name: mod
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
             └──Primitive name: %mod
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: bool
                   └──Desc: Variable: is_even
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: bool
                                        └──Desc: Primitive: (=)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: mod
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 2
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: bool
                   └──Desc: Variable: evens
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: bool
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: bool
                                        └──Desc: Variable
                                           └──Variable: map
                                           └──Type expr: Constructor: bool
                                           └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: t
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Variable
                                     └──Variable: is_even
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: bool
                   └──Desc: Variable: evens
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: int
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: bool
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: bool
                                        └──Desc: Variable
                                           └──Variable: map
                                           └──Type expr: Constructor: bool
                                           └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: t
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Function
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Primitive: (=)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: mod
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 2
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      external lt : 'a. 'a -> 'a -> bool = "%less_than";;

      let rec merge = 
        fun compare t1 t2 ->
          match (t1, t2) with
          ( (Nil, t) -> t
          | (t, Nil) -> t
          | (Cons (x1, t1), Cons (x2, t2)) ->
              if lt (compare x1 x2) 0 
                then Cons (x1, merge compare t1 (Cons (x2, t2)))
                else Cons (x2, merge compare (Cons (x1, t1)) t2)   
          ) 
      ;;

      external take : 'a. 'a list -> int -> 'a list = "%take";;
      external drop : 'a. 'a list -> int -> 'a list = "%drop";;
      external length : 'a. 'a list -> int = "%length";;

      let rec merge_sort =
        fun compare t ->
          match t with
          ( Nil -> Nil
          | Cons (x, Nil) -> Cons (x, Nil)
          | _ ->
              let n = length t / 2 in
              let left = take t n in
              let right = drop t n in
              merge compare (merge_sort compare left) (merge_sort compare right)
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 2432
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2432
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 2432
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2432
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 2432
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2432
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 2437
                └──Type expr: Arrow
                   └──Type expr: Variable: 2437
                   └──Type expr: Arrow
                      └──Type expr: Variable: 2437
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: merge
                └──Abstraction:
                   └──Variables: 2575
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 2575
                            └──Type expr: Arrow
                               └──Type expr: Variable: 2575
                               └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2575
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2575
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2575
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 2575
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 2575
                                  └──Type expr: Constructor: int
                            └──Desc: Variable: compare
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2575
                               └──Type expr: Arrow
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2575
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2575
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2575
                                  └──Desc: Variable: t1
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2575
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2575
                                  └──Desc: Function
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2575
                                        └──Desc: Variable: t2
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2575
                                        └──Desc: Match
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2575
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 2575
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2575
                                                    └──Desc: Variable
                                                       └──Variable: t1
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2575
                                                    └──Desc: Variable
                                                       └──Variable: t2
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2575
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2575
                                           └──Cases:
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2575
                                                    └──Desc: Variable
                                                       └──Variable: t
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Variable: t
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2575
                                                    └──Desc: Variable
                                                       └──Variable: t
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2575
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 2575
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                             └──Pattern:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 2575
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                                └──Desc: Tuple
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 2575
                                                                      └──Desc: Variable: x1
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                      └──Desc: Variable: t1
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 2575
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                             └──Pattern:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 2575
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                                └──Desc: Tuple
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 2575
                                                                      └──Desc: Variable: x2
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                      └──Desc: Variable: t2
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2575
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Variable
                                                                         └──Variable: lt
                                                                         └──Type expr: Constructor: int
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 2575
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 2575
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 2575
                                                                                        └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: compare
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 2575
                                                                                  └──Desc: Variable
                                                                                     └──Variable: x1
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 2575
                                                                            └──Desc: Variable
                                                                               └──Variable: x2
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 0
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 2575
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 2575
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 2575
                                                                      └──Desc: Variable
                                                                         └──Variable: x1
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2575
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2575
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2575
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Variable: 2575
                                                                                                 └──Type expr: Constructor: int
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2575
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Variable: 2575
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Variable: 2575
                                                                                        └──Desc: Variable
                                                                                           └──Variable: merge
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 2575
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Type expr: Constructor: int
                                                                                        └──Desc: Variable
                                                                                           └──Variable: compare
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2575
                                                                                  └──Desc: Variable
                                                                                     └──Variable: t1
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2575
                                                                            └──Desc: Construct
                                                                               └──Constructor description:
                                                                                  └──Name: Cons
                                                                                  └──Constructor argument type:
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 2575
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                  └──Constructor type:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2575
                                                                               └──Expression:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 2575
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2575
                                                                                  └──Desc: Tuple
                                                                                     └──Expression:
                                                                                        └──Type expr: Variable: 2575
                                                                                        └──Desc: Variable
                                                                                           └──Variable: x2
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                        └──Desc: Variable
                                                                                           └──Variable: t2
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2575
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 2575
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 2575
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2575
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 2575
                                                                      └──Desc: Variable
                                                                         └──Variable: x2
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2575
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2575
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2575
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2575
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2575
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Variable: 2575
                                                                                                 └──Type expr: Constructor: int
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2575
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Variable: 2575
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Variable: 2575
                                                                                        └──Desc: Variable
                                                                                           └──Variable: merge
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 2575
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Type expr: Constructor: int
                                                                                        └──Desc: Variable
                                                                                           └──Variable: compare
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2575
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Cons
                                                                                        └──Constructor argument type:
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2575
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Variable: 2575
                                                                                     └──Expression:
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Variable: 2575
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Variable: 2575
                                                                                        └──Desc: Tuple
                                                                                           └──Expression:
                                                                                              └──Type expr: Variable: 2575
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: x1
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2575
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: t1
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2575
                                                                            └──Desc: Variable
                                                                               └──Variable: t2
       └──Structure item: Primitive
          └──Value description:
             └──Name: take
             └──Scheme:
                └──Variables: 2588
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 2588
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2588
             └──Primitive name: %take
       └──Structure item: Primitive
          └──Value description:
             └──Name: drop
             └──Scheme:
                └──Variables: 2599
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 2599
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2599
             └──Primitive name: %drop
       └──Structure item: Primitive
          └──Value description:
             └──Name: length
             └──Scheme:
                └──Variables: 2610
                └──Type expr: Arrow
                   └──Type expr: Constructor: list
                      └──Type expr: Variable: 2610
                   └──Type expr: Constructor: int
             └──Primitive name: %length
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: merge_sort
                └──Abstraction:
                   └──Variables: 2709
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 2709
                            └──Type expr: Arrow
                               └──Type expr: Variable: 2709
                               └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2709
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2709
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 2709
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 2709
                                  └──Type expr: Constructor: int
                            └──Desc: Variable: compare
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2709
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2709
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2709
                                  └──Desc: Variable: t
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2709
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2709
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2709
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2709
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2709
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2709
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 2709
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2709
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2709
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2709
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2709
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2709
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2709
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 2709
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2709
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2709
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Any
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2709
                                              └──Desc: Let
                                                 └──Value bindings:
                                                    └──Value binding:
                                                       └──Pattern:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable: n
                                                       └──Abstraction:
                                                          └──Variables:
                                                          └──Expression:
                                                             └──Type expr: Constructor: int
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: int
                                                                         └──Desc: Primitive: (/)
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: int
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                                  └──Type expr: Constructor: int
                                                                               └──Desc: Variable
                                                                                  └──Variable: length
                                                                                  └──Type expr: Variable: 2709
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2709
                                                                               └──Desc: Variable
                                                                                  └──Variable: t
                                                                └──Expression:
                                                                   └──Type expr: Constructor: int
                                                                   └──Desc: Constant: 2
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2709
                                                    └──Desc: Let
                                                       └──Value bindings:
                                                          └──Value binding:
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 2709
                                                                └──Desc: Variable: left
                                                             └──Abstraction:
                                                                └──Variables:
                                                                └──Expression:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2709
                                                                   └──Desc: Application
                                                                      └──Expression:
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2709
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2709
                                                                               └──Desc: Variable
                                                                                  └──Variable: take
                                                                                  └──Type expr: Variable: 2709
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2709
                                                                               └──Desc: Variable
                                                                                  └──Variable: t
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: int
                                                                         └──Desc: Variable
                                                                            └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2709
                                                          └──Desc: Let
                                                             └──Value bindings:
                                                                └──Value binding:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2709
                                                                      └──Desc: Variable: right
                                                                   └──Abstraction:
                                                                      └──Variables:
                                                                      └──Expression:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2709
                                                                         └──Desc: Application
                                                                            └──Expression:
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                               └──Desc: Application
                                                                                  └──Expression:
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2709
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Variable: 2709
                                                                                     └──Desc: Variable
                                                                                        └──Variable: drop
                                                                                        └──Type expr: Variable: 2709
                                                                                  └──Expression:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2709
                                                                                     └──Desc: Variable
                                                                                        └──Variable: t
                                                                            └──Expression:
                                                                               └──Type expr: Constructor: int
                                                                               └──Desc: Variable
                                                                                  └──Variable: n
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 2709
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2709
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2709
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2709
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 2709
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 2709
                                                                                           └──Type expr: Constructor: int
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2709
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Variable: 2709
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Variable: 2709
                                                                                  └──Desc: Variable
                                                                                     └──Variable: merge
                                                                                     └──Type expr: Variable: 2709
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 2709
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 2709
                                                                                        └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: compare
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2709
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2709
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2709
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2709
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Variable: 2709
                                                                                                 └──Type expr: Constructor: int
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2709
                                                                                              └──Type expr: Constructor: list
                                                                                                 └──Type expr: Variable: 2709
                                                                                        └──Desc: Variable
                                                                                           └──Variable: merge_sort
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 2709
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 2709
                                                                                              └──Type expr: Constructor: int
                                                                                        └──Desc: Variable
                                                                                           └──Variable: compare
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2709
                                                                                  └──Desc: Variable
                                                                                     └──Variable: left
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2709
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2709
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2709
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 2709
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 2709
                                                                                           └──Type expr: Constructor: int
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2709
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2709
                                                                                  └──Desc: Variable
                                                                                     └──Variable: merge_sort
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 2709
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 2709
                                                                                        └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: compare
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2709
                                                                            └──Desc: Variable
                                                                               └──Variable: right |}]

let%expect_test "" =
  let str = 
    {|
      exception Problem;;

      exception Not_prime of int;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Problem
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Not_prime
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
                      └──Constructor argument:
                         └──Constructor betas:
                         └──Type expr: Constructor: int |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      external raise : 'a. exn -> 'a = "%raise";;

      external lt : 'a. 'a -> 'a -> bool = "%less_than";;

      exception Invalid_argument of string;;

      let rec take = 
        fun t n ->
          match t with
          ( Nil -> 
            if n = 0 then Nil 
            else raise (Invalid_argument "take")
          | Cons (x, t) ->
            if lt n 0 then raise (Invalid_argument "take")
            else if n = 0 then Nil 
            else Cons (x, take t (n - 1))
          )
      ;;

      let rec drop = 
        fun t n ->
          match t with
          ( Nil -> 
            if n = 0 then Nil 
            else raise (Invalid_argument "drop")
          | Cons (x, t') ->
            if lt n 0 then raise (Invalid_argument "drop")
            else if n = 0 then t' 
            else drop t (n - 1)
          )
      ;;
      
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 2745
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2745
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 2745
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 2745
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 2745
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2745
       └──Structure item: Primitive
          └──Value description:
             └──Name: raise
             └──Scheme:
                └──Variables: 2752
                └──Type expr: Arrow
                   └──Type expr: Constructor: exn
                   └──Type expr: Variable: 2752
             └──Primitive name: %raise
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 2757
                └──Type expr: Arrow
                   └──Type expr: Variable: 2757
                   └──Type expr: Arrow
                      └──Type expr: Variable: 2757
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Invalid_argument
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
                      └──Constructor argument:
                         └──Constructor betas:
                         └──Type expr: Constructor: string
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: take
                └──Abstraction:
                   └──Variables: 2872
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2872
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2872
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2872
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2872
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2872
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2872
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2872
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2872
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2872
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2872
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Primitive: (=)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 0
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2872
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2872
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2872
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: exn
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2872
                                                          └──Desc: Variable
                                                             └──Variable: raise
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2872
                                                       └──Expression:
                                                          └──Type expr: Constructor: exn
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Invalid_argument
                                                                └──Constructor argument type:
                                                                   └──Type expr: Constructor: string
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: exn
                                                             └──Expression:
                                                                └──Type expr: Constructor: string
                                                                └──Desc: Constant: take
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2872
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2872
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2872
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2872
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2872
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2872
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 2872
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2872
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2872
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: lt
                                                                   └──Type expr: Constructor: int
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 0
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2872
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: exn
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2872
                                                          └──Desc: Variable
                                                             └──Variable: raise
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2872
                                                       └──Expression:
                                                          └──Type expr: Constructor: exn
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Invalid_argument
                                                                └──Constructor argument type:
                                                                   └──Type expr: Constructor: string
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: exn
                                                             └──Expression:
                                                                └──Type expr: Constructor: string
                                                                └──Desc: Constant: take
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2872
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Primitive: (=)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: n
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 0
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2872
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Nil
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2872
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2872
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 2872
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2872
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2872
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 2872
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2872
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 2872
                                                                      └──Desc: Variable
                                                                         └──Variable: x
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2872
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 2872
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Variable: 2872
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Variable: 2872
                                                                                  └──Desc: Variable
                                                                                     └──Variable: take
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Variable: 2872
                                                                                  └──Desc: Variable
                                                                                     └──Variable: t
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Constructor: int
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Type expr: Constructor: int
                                                                                        └──Desc: Primitive: (-)
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Desc: Variable
                                                                                           └──Variable: n
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: drop
                └──Abstraction:
                   └──Variables: 2941
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 2941
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2941
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 2941
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 2941
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: n
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 2941
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 2941
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 2941
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2941
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2941
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2941
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Primitive: (=)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 0
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2941
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2941
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2941
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: exn
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2941
                                                          └──Desc: Variable
                                                             └──Variable: raise
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2941
                                                       └──Expression:
                                                          └──Type expr: Constructor: exn
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Invalid_argument
                                                                └──Constructor argument type:
                                                                   └──Type expr: Constructor: string
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: exn
                                                             └──Expression:
                                                                └──Type expr: Constructor: string
                                                                └──Desc: Constant: drop
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2941
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 2941
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2941
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2941
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 2941
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 2941
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 2941
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2941
                                                          └──Desc: Variable: t'
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 2941
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: lt
                                                                   └──Type expr: Constructor: int
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: n
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 0
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2941
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: exn
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2941
                                                          └──Desc: Variable
                                                             └──Variable: raise
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 2941
                                                       └──Expression:
                                                          └──Type expr: Constructor: exn
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Invalid_argument
                                                                └──Constructor argument type:
                                                                   └──Type expr: Constructor: string
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: exn
                                                             └──Expression:
                                                                └──Type expr: Constructor: string
                                                                └──Desc: Constant: drop
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 2941
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Primitive: (=)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: n
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 0
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2941
                                                          └──Desc: Variable
                                                             └──Variable: t'
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 2941
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 2941
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 2941
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 2941
                                                                      └──Desc: Variable
                                                                         └──Variable: drop
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 2941
                                                                      └──Desc: Variable
                                                                         └──Variable: t
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: int
                                                                            └──Desc: Primitive: (-)
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Variable
                                                                               └──Variable: n
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Constant: 1 |}]

let%expect_test "" =
  let str = 
    {|
      exception Division_by_zero;;

      
      let safe_divide = 
        fun x y ->
          try x / y with (Division_by_zero -> 0)
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Division_by_zero
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                   └──Desc: Variable: safe_divide
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: y
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Try
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (/)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: y
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Division_by_zero
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      external raise : 'a. exn -> 'a = "%raise";;

      exception Not_found;;

      let rec last = 
        fun t ->
          match t with
          ( Nil -> raise Not_found
          | Cons (x, Nil) -> x
          | Cons (_, t) -> last t
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 3070
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3070
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 3070
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3070
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3070
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3070
       └──Structure item: Primitive
          └──Value description:
             └──Name: raise
             └──Scheme:
                └──Variables: 3076
                └──Type expr: Arrow
                   └──Type expr: Constructor: exn
                   └──Type expr: Variable: 3076
             └──Primitive name: %raise
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Not_found
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: last
                └──Abstraction:
                   └──Variables: 3112
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3112
                         └──Type expr: Variable: 3112
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3112
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Variable: 3112
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3112
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3112
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3112
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                     └──Expression:
                                        └──Type expr: Variable: 3112
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: exn
                                                 └──Type expr: Variable: 3112
                                              └──Desc: Variable
                                                 └──Variable: raise
                                                 └──Type expr: Variable: 3112
                                           └──Expression:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Not_found
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3112
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3112
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 3112
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 3112
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 3112
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 3112
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3112
                                     └──Expression:
                                        └──Type expr: Variable: 3112
                                        └──Desc: Variable
                                           └──Variable: x
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3112
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3112
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 3112
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 3112
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Variable: 3112
                                                    └──Desc: Any
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 3112
                                                    └──Desc: Variable: t
                                     └──Expression:
                                        └──Type expr: Variable: 3112
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3112
                                                 └──Type expr: Variable: 3112
                                              └──Desc: Variable
                                                 └──Variable: last
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3112
                                              └──Desc: Variable
                                                 └──Variable: t |}]

let%expect_test "" =
  let str = 
    {|
      let p = (1, 4);;

      let q = (1, '1');;

      let fst = 
        fun t -> match t with ((x, _) -> x)
      ;;

      let snd = 
        fun t -> match t with ((_, x) -> x)
      ;;

      let fst = 
        fun (x, _) -> x
      ;;

      let snd = 
        fun (_, x) -> x
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Tuple
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Variable: p
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Tuple
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 1
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 4
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Tuple
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: char
                   └──Desc: Variable: q
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: char
                      └──Desc: Tuple
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 1
                         └──Expression:
                            └──Type expr: Constructor: char
                            └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3147
                         └──Type expr: Variable: 3151
                      └──Type expr: Variable: 3147
                   └──Desc: Variable: fst
                └──Abstraction:
                   └──Variables: 3151,3147,3147
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Variable: 3147
                            └──Type expr: Variable: 3151
                         └──Type expr: Variable: 3147
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3147
                               └──Type expr: Variable: 3151
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Variable: 3147
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 3147
                                     └──Type expr: Variable: 3151
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3147
                                  └──Type expr: Variable: 3151
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 3147
                                           └──Type expr: Variable: 3151
                                        └──Desc: Tuple
                                           └──Pattern:
                                              └──Type expr: Variable: 3147
                                              └──Desc: Variable: x
                                           └──Pattern:
                                              └──Type expr: Variable: 3151
                                              └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Variable: 3147
                                        └──Desc: Variable
                                           └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3162
                         └──Type expr: Variable: 3157
                      └──Type expr: Variable: 3157
                   └──Desc: Variable: snd
                └──Abstraction:
                   └──Variables: 3157,3162,3157
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Variable: 3162
                            └──Type expr: Variable: 3157
                         └──Type expr: Variable: 3157
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3162
                               └──Type expr: Variable: 3157
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Variable: 3157
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 3162
                                     └──Type expr: Variable: 3157
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3162
                                  └──Type expr: Variable: 3157
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 3162
                                           └──Type expr: Variable: 3157
                                        └──Desc: Tuple
                                           └──Pattern:
                                              └──Type expr: Variable: 3162
                                              └──Desc: Any
                                           └──Pattern:
                                              └──Type expr: Variable: 3157
                                              └──Desc: Variable: x
                                     └──Expression:
                                        └──Type expr: Variable: 3157
                                        └──Desc: Variable
                                           └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3167
                         └──Type expr: Variable: 3170
                      └──Type expr: Variable: 3167
                   └──Desc: Variable: fst
                └──Abstraction:
                   └──Variables: 3170,3167,3167
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Variable: 3167
                            └──Type expr: Variable: 3170
                         └──Type expr: Variable: 3167
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3167
                               └──Type expr: Variable: 3170
                            └──Desc: Tuple
                               └──Pattern:
                                  └──Type expr: Variable: 3167
                                  └──Desc: Variable: x
                               └──Pattern:
                                  └──Type expr: Variable: 3170
                                  └──Desc: Any
                         └──Expression:
                            └──Type expr: Variable: 3167
                            └──Desc: Variable
                               └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3180
                         └──Type expr: Variable: 3176
                      └──Type expr: Variable: 3176
                   └──Desc: Variable: snd
                └──Abstraction:
                   └──Variables: 3176,3180,3176
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Variable: 3180
                            └──Type expr: Variable: 3176
                         └──Type expr: Variable: 3176
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3180
                               └──Type expr: Variable: 3176
                            └──Desc: Tuple
                               └──Pattern:
                                  └──Type expr: Variable: 3180
                                  └──Desc: Any
                               └──Pattern:
                                  └──Type expr: Variable: 3176
                                  └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Variable: 3176
                            └──Desc: Variable
                               └──Variable: x |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      external raise : 'a. exn -> 'a = "%raise";;

      external eq : 'a. 'a -> 'a -> bool = "%equal";;

      exception Not_found;;

      let rec find = 
        fun t k ->
          match t with
          ( Nil -> raise Not_found
          | Cons ((k', d), t) ->
              if eq k k' then d else find t k 
          )          
      ;;

      let rec add = 
        fun t k d ->
          match t with
          ( Nil -> Cons ((k, d), Nil)
          | Cons ((k', d'), t) ->
              if eq k k'
                then Cons ((k, d), t)
                else Cons ((k', d'), add t k d)
          ) 
      ;;

      let rec remove = 
        fun t k ->
          match t with
          ( Nil -> Nil
          | Cons ((k', d'), t) ->
              if eq k k'
                then t
                else Cons ((k', d'), remove t k)  
          )
      ;;

      let mem = 
        fun t k ->
          try (let _ = find t k in true) with
          ( Not_found -> false )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 3183
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3183
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 3183
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3183
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3183
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3183
       └──Structure item: Primitive
          └──Value description:
             └──Name: raise
             └──Scheme:
                └──Variables: 3189
                └──Type expr: Arrow
                   └──Type expr: Constructor: exn
                   └──Type expr: Variable: 3189
             └──Primitive name: %raise
       └──Structure item: Primitive
          └──Value description:
             └──Name: eq
             └──Scheme:
                └──Variables: 3194
                └──Type expr: Arrow
                   └──Type expr: Variable: 3194
                   └──Type expr: Arrow
                      └──Type expr: Variable: 3194
                      └──Type expr: Constructor: bool
             └──Primitive name: %equal
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Not_found
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: find
                └──Abstraction:
                   └──Variables: 3207,3249
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3249
                               └──Type expr: Variable: 3207
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3249
                            └──Type expr: Variable: 3207
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3249
                                  └──Type expr: Variable: 3207
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3249
                               └──Type expr: Variable: 3207
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 3249
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Variable: 3207
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 3249
                                              └──Type expr: Variable: 3207
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 3249
                                           └──Type expr: Variable: 3207
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3249
                                                    └──Type expr: Variable: 3207
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                           └──Expression:
                                              └──Type expr: Variable: 3207
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: exn
                                                       └──Type expr: Variable: 3207
                                                    └──Desc: Variable
                                                       └──Variable: raise
                                                       └──Type expr: Variable: 3207
                                                 └──Expression:
                                                    └──Type expr: Constructor: exn
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Not_found
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: exn
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3249
                                                    └──Type expr: Variable: 3207
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3249
                                                                └──Type expr: Variable: 3207
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3249
                                                          └──Type expr: Variable: 3207
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 3249
                                                                └──Desc: Variable: k'
                                                             └──Pattern:
                                                                └──Type expr: Variable: 3207
                                                                └──Desc: Variable: d
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3249
                                                                └──Type expr: Variable: 3207
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Variable: 3207
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3249
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3249
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: eq
                                                                   └──Type expr: Variable: 3249
                                                             └──Expression:
                                                                └──Type expr: Variable: 3249
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Variable: 3249
                                                          └──Desc: Variable
                                                             └──Variable: k'
                                                 └──Expression:
                                                    └──Type expr: Variable: 3207
                                                    └──Desc: Variable
                                                       └──Variable: d
                                                 └──Expression:
                                                    └──Type expr: Variable: 3207
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 3249
                                                             └──Type expr: Variable: 3207
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3249
                                                                         └──Type expr: Variable: 3207
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3249
                                                                      └──Type expr: Variable: 3207
                                                                └──Desc: Variable
                                                                   └──Variable: find
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3249
                                                                      └──Type expr: Variable: 3207
                                                                └──Desc: Variable
                                                                   └──Variable: t
                                                       └──Expression:
                                                          └──Type expr: Variable: 3249
                                                          └──Desc: Variable
                                                             └──Variable: k
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: add
                └──Abstraction:
                   └──Variables: 3349,3352
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3352
                               └──Type expr: Variable: 3349
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3352
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3349
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 3352
                                     └──Type expr: Variable: 3349
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3352
                                  └──Type expr: Variable: 3349
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3352
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 3349
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Variable: 3352
                                        └──Type expr: Variable: 3349
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 3352
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 3349
                                     └──Type expr: Constructor: list
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 3352
                                           └──Type expr: Variable: 3349
                                  └──Desc: Function
                                     └──Pattern:
                                        └──Type expr: Variable: 3349
                                        └──Desc: Variable: d
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 3352
                                              └──Type expr: Variable: 3349
                                        └──Desc: Match
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3352
                                                    └──Type expr: Variable: 3349
                                              └──Desc: Variable
                                                 └──Variable: t
                                           └──Type expr: Constructor: list
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 3352
                                                 └──Type expr: Variable: 3349
                                           └──Cases:
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3352
                                                          └──Type expr: Variable: 3349
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Nil
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3352
                                                          └──Type expr: Variable: 3349
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3352
                                                                └──Type expr: Variable: 3349
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3352
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3349
                                                                      └──Desc: Variable
                                                                         └──Variable: d
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Nil
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 3352
                                                                               └──Type expr: Variable: 3349
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3352
                                                          └──Type expr: Variable: 3349
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3352
                                                                └──Type expr: Variable: 3349
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Variable: 3349
                                                                └──Desc: Tuple
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 3352
                                                                      └──Desc: Variable: k'
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 3349
                                                                      └──Desc: Variable: d'
                                                             └──Pattern:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                                └──Desc: Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3352
                                                          └──Type expr: Variable: 3349
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3352
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 3352
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Variable
                                                                         └──Variable: eq
                                                                         └──Type expr: Variable: 3352
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3352
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                             └──Expression:
                                                                └──Type expr: Variable: 3352
                                                                └──Desc: Variable
                                                                   └──Variable: k'
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3352
                                                                └──Type expr: Variable: 3349
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 3352
                                                                            └──Type expr: Variable: 3349
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 3352
                                                                            └──Desc: Variable
                                                                               └──Variable: k
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 3349
                                                                            └──Desc: Variable
                                                                               └──Variable: d
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 3352
                                                                            └──Type expr: Variable: 3349
                                                                      └──Desc: Variable
                                                                         └──Variable: t
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3352
                                                                └──Type expr: Variable: 3349
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 3352
                                                                            └──Type expr: Variable: 3349
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3352
                                                                      └──Type expr: Variable: 3349
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3352
                                                                         └──Type expr: Variable: 3349
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 3352
                                                                            └──Desc: Variable
                                                                               └──Variable: k'
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 3349
                                                                            └──Desc: Variable
                                                                               └──Variable: d'
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 3352
                                                                            └──Type expr: Variable: 3349
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 3349
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 3352
                                                                                     └──Type expr: Variable: 3349
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 3352
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 3349
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 3352
                                                                                              └──Type expr: Variable: 3349
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 3352
                                                                                                 └──Type expr: Variable: 3349
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 3352
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Variable: 3349
                                                                                                 └──Type expr: Constructor: list
                                                                                                    └──Type expr: Tuple
                                                                                                       └──Type expr: Variable: 3352
                                                                                                       └──Type expr: Variable: 3349
                                                                                        └──Desc: Variable
                                                                                           └──Variable: add
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: list
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 3352
                                                                                              └──Type expr: Variable: 3349
                                                                                        └──Desc: Variable
                                                                                           └──Variable: t
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 3352
                                                                                  └──Desc: Variable
                                                                                     └──Variable: k
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 3349
                                                                            └──Desc: Variable
                                                                               └──Variable: d
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: remove
                └──Abstraction:
                   └──Variables: 3381,3418
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3418
                               └──Type expr: Variable: 3381
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3418
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3418
                                  └──Type expr: Variable: 3381
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3418
                                  └──Type expr: Variable: 3381
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3418
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 3418
                                     └──Type expr: Variable: 3381
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 3418
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Variable: 3418
                                        └──Type expr: Variable: 3381
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 3418
                                              └──Type expr: Variable: 3381
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 3418
                                           └──Type expr: Variable: 3381
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3418
                                                    └──Type expr: Variable: 3381
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3418
                                                    └──Type expr: Variable: 3381
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3418
                                                    └──Type expr: Variable: 3381
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3418
                                                                └──Type expr: Variable: 3381
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3418
                                                          └──Type expr: Variable: 3381
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Variable: 3381
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 3418
                                                                └──Desc: Variable: k'
                                                             └──Pattern:
                                                                └──Type expr: Variable: 3381
                                                                └──Desc: Variable: d'
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3418
                                                                └──Type expr: Variable: 3381
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 3418
                                                    └──Type expr: Variable: 3381
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 3418
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3418
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3418
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: eq
                                                                   └──Type expr: Variable: 3418
                                                             └──Expression:
                                                                └──Type expr: Variable: 3418
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Variable: 3418
                                                          └──Desc: Variable
                                                             └──Variable: k'
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3418
                                                          └──Type expr: Variable: 3381
                                                    └──Desc: Variable
                                                       └──Variable: t
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3418
                                                          └──Type expr: Variable: 3381
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3418
                                                                   └──Type expr: Variable: 3381
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3418
                                                                      └──Type expr: Variable: 3381
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3418
                                                                   └──Type expr: Variable: 3381
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 3418
                                                                └──Type expr: Variable: 3381
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3418
                                                                   └──Type expr: Variable: 3381
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 3418
                                                                   └──Type expr: Variable: 3381
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3418
                                                                      └──Desc: Variable
                                                                         └──Variable: k'
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3381
                                                                      └──Desc: Variable
                                                                         └──Variable: d'
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 3418
                                                                      └──Type expr: Variable: 3381
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 3418
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 3418
                                                                               └──Type expr: Variable: 3381
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 3418
                                                                                     └──Type expr: Variable: 3381
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Variable: 3418
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 3418
                                                                                        └──Type expr: Variable: 3381
                                                                            └──Desc: Variable
                                                                               └──Variable: remove
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 3418
                                                                                  └──Type expr: Variable: 3381
                                                                            └──Desc: Variable
                                                                               └──Variable: t
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 3418
                                                                      └──Desc: Variable
                                                                         └──Variable: k
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Tuple
                            └──Type expr: Variable: 3437
                            └──Type expr: Variable: 3436
                      └──Type expr: Arrow
                         └──Type expr: Variable: 3437
                         └──Type expr: Constructor: bool
                   └──Desc: Variable: mem
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Variable: 3437
                               └──Type expr: Variable: 3436
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3437
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 3437
                                  └──Type expr: Variable: 3436
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3437
                               └──Type expr: Constructor: bool
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 3437
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Try
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Let
                                           └──Value bindings:
                                              └──Value binding:
                                                 └──Pattern:
                                                    └──Type expr: Variable: 3436
                                                    └──Desc: Any
                                                 └──Abstraction:
                                                    └──Variables:
                                                    └──Expression:
                                                       └──Type expr: Variable: 3436
                                                       └──Desc: Application
                                                          └──Expression:
                                                             └──Type expr: Arrow
                                                                └──Type expr: Variable: 3437
                                                                └──Type expr: Variable: 3436
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 3437
                                                                            └──Type expr: Variable: 3436
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 3437
                                                                         └──Type expr: Variable: 3436
                                                                   └──Desc: Variable
                                                                      └──Variable: find
                                                                      └──Type expr: Variable: 3436
                                                                      └──Type expr: Variable: 3437
                                                                └──Expression:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 3437
                                                                         └──Type expr: Variable: 3436
                                                                   └──Desc: Variable
                                                                      └──Variable: t
                                                          └──Expression:
                                                             └──Type expr: Variable: 3437
                                                             └──Desc: Variable
                                                                └──Variable: k
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Constant: true
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Not_found
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Constant: false |}]

let%expect_test "" =
  let str = 
    {|
      let add = 
        fun x y -> x + y
      ;;

      let f = add 6;;

      let _ = f 5;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                   └──Desc: Variable: add
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: y
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: y
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Variable: f
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Arrow
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: add
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 6
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: f
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 5 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec map = 
        fun t f ->
          match t with
          ( Nil -> Nil
          | Cons (x, t) -> Cons (f x, map t f)
          )
      ;;

      let _ = map (Cons (10, Cons (20, Cons (30, Nil)))) (fun x -> x + 6);;

      let rec maptt = 
        fun tt f -> 
          match tt with
          ( Nil -> Nil
          | Cons (t, tt) -> Cons (map t f, maptt tt f)
          )
      ;;

      let maptt = fun tt f -> map tt (fun t -> map t f);;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 3497
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3497
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 3497
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3497
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3497
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3497
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: map
                └──Abstraction:
                   └──Variables: 3529,3540
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3540
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3540
                               └──Type expr: Variable: 3529
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3529
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3540
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 3540
                                  └──Type expr: Variable: 3529
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3529
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 3540
                                     └──Type expr: Variable: 3529
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3529
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3540
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3540
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3540
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3540
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3529
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3529
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3540
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3540
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3540
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3540
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 3540
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3540
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 3540
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3540
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3529
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 3529
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3529
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3529
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 3529
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3529
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Variable: 3529
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3540
                                                                   └──Type expr: Variable: 3529
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                             └──Expression:
                                                                └──Type expr: Variable: 3540
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3529
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3540
                                                                      └──Type expr: Variable: 3529
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 3529
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 3540
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 3540
                                                                               └──Type expr: Variable: 3529
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 3529
                                                                      └──Desc: Variable
                                                                         └──Variable: map
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 3540
                                                                      └──Desc: Variable
                                                                         └──Variable: t
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3540
                                                                   └──Type expr: Variable: 3529
                                                                └──Desc: Variable
                                                                   └──Variable: f
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: int
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: int
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: map
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: int
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: int
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: int
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 10
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: int
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: int
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 20
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: int
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: int
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Constant: 30
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Nil
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: int
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 6
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: maptt
                └──Abstraction:
                   └──Variables: 3677,3674
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3674
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3674
                               └──Type expr: Variable: 3677
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3677
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3674
                            └──Desc: Variable: tt
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 3674
                                  └──Type expr: Variable: 3677
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3677
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 3674
                                     └──Type expr: Variable: 3677
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3677
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 3674
                                        └──Desc: Variable
                                           └──Variable: tt
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3674
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3674
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3674
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3677
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3677
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3674
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3674
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3674
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3674
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3674
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3674
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3674
                                                          └──Desc: Variable: t
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3674
                                                          └──Desc: Variable: tt
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3677
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3677
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3677
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3677
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3677
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3677
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3677
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3674
                                                                      └──Type expr: Variable: 3677
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Variable: 3677
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 3674
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 3674
                                                                               └──Type expr: Variable: 3677
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 3677
                                                                      └──Desc: Variable
                                                                         └──Variable: map
                                                                         └──Type expr: Variable: 3677
                                                                         └──Type expr: Variable: 3674
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 3674
                                                                      └──Desc: Variable
                                                                         └──Variable: t
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3674
                                                                   └──Type expr: Variable: 3677
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3677
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 3674
                                                                      └──Type expr: Variable: 3677
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 3677
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Variable: 3674
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 3674
                                                                               └──Type expr: Variable: 3677
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Variable: 3677
                                                                      └──Desc: Variable
                                                                         └──Variable: maptt
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Variable: 3674
                                                                      └──Desc: Variable
                                                                         └──Variable: tt
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3674
                                                                   └──Type expr: Variable: 3677
                                                                └──Desc: Variable
                                                                   └──Variable: f
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3720
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3720
                            └──Type expr: Variable: 3723
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3723
                   └──Desc: Variable: maptt
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3720
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3720
                               └──Type expr: Variable: 3723
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3723
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3720
                            └──Desc: Variable: tt
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 3720
                                  └──Type expr: Variable: 3723
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3723
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 3720
                                     └──Type expr: Variable: 3723
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3723
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3720
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3723
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3723
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Variable: 3720
                                                 └──Type expr: Arrow
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3720
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3723
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3723
                                              └──Desc: Variable
                                                 └──Variable: map
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3723
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3720
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Variable: 3720
                                              └──Desc: Variable
                                                 └──Variable: tt
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 3720
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 3723
                                        └──Desc: Function
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3720
                                              └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3723
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Arrow
                                                          └──Type expr: Variable: 3720
                                                          └──Type expr: Variable: 3723
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 3723
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 3720
                                                             └──Type expr: Arrow
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 3720
                                                                   └──Type expr: Variable: 3723
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Variable: 3723
                                                          └──Desc: Variable
                                                             └──Variable: map
                                                             └──Type expr: Variable: 3723
                                                             └──Type expr: Variable: 3720
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 3720
                                                          └──Desc: Variable
                                                             └──Variable: t
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Variable: 3720
                                                       └──Type expr: Variable: 3723
                                                    └──Desc: Variable
                                                       └──Variable: f |}]

let%expect_test "" =
  let str = 
    {|
      external map : 'a 'b. ('a -> 'b) -> 'a list -> 'b list = "%map";;

      let maptt = fun f -> map (map f);;

      let add = fun x -> fun y -> x + y;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: map
             └──Scheme:
                └──Variables: 3726,3725
                └──Type expr: Arrow
                   └──Type expr: Arrow
                      └──Type expr: Variable: 3725
                      └──Type expr: Variable: 3726
                   └──Type expr: Arrow
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3725
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3726
             └──Primitive name: %map
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Arrow
                         └──Type expr: Variable: 3757
                         └──Type expr: Variable: 3758
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3757
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 3758
                   └──Desc: Variable: maptt
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 3757
                            └──Type expr: Variable: 3758
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3757
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 3758
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 3757
                               └──Type expr: Variable: 3758
                            └──Desc: Variable: f
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3757
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 3758
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3757
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 3758
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 3757
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: list
                                              └──Type expr: Variable: 3758
                                  └──Desc: Variable
                                     └──Variable: map
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3758
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3757
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3757
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 3758
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Arrow
                                              └──Type expr: Variable: 3757
                                              └──Type expr: Variable: 3758
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3757
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 3758
                                        └──Desc: Variable
                                           └──Variable: map
                                           └──Type expr: Variable: 3758
                                           └──Type expr: Variable: 3757
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Variable: 3757
                                           └──Type expr: Variable: 3758
                                        └──Desc: Variable
                                           └──Variable: f
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                   └──Desc: Variable: add
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Arrow
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable: y
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: x
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: y |}]

let%expect_test "" =
  let str = 
    {|
      type color = 
        | Red
        | Green
        | Blue
        | Yellow
      ;;

      let col = Blue;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let cols = Cons (Red, Cons (Red, Cons (Green, Cons (Yellow, Nil))));;
      
      let col_pair = ('R', Red);;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: color
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Red
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Green
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Blue
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Yellow
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: color
                   └──Desc: Variable: col
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: color
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Blue
                            └──Constructor type:
                               └──Type expr: Constructor: color
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 3791
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3791
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 3791
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3791
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3791
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3791
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: color
                   └──Desc: Variable: cols
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: color
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Cons
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: color
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: color
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: color
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: color
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: color
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: color
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Red
                                        └──Constructor type:
                                           └──Type expr: Constructor: color
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: color
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: color
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: color
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: color
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: color
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: color
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Red
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: color
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: color
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: color
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: color
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: color
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: color
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: color
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: color
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Green
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: color
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: color
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: color
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: color
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: color
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: color
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: color
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: color
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Yellow
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: color
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: color
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Nil
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: color
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Tuple
                      └──Type expr: Constructor: char
                      └──Type expr: Constructor: color
                   └──Desc: Variable: col_pair
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: char
                         └──Type expr: Constructor: color
                      └──Desc: Tuple
                         └──Expression:
                            └──Type expr: Constructor: char
                            └──Desc: Constant: R
                         └──Expression:
                            └──Type expr: Constructor: color
                            └──Desc: Construct
                               └──Constructor description:
                                  └──Name: Red
                                  └──Constructor type:
                                     └──Type expr: Constructor: color |}]

let%expect_test "" =
  let str = 
    {|
      type color = 
        | Red
        | Green
        | Yellow
        | Blue
        | Rgb of int * int * int
      ;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let cols = Cons (Red, Cons (Red, Cons (Green, Cons (Yellow, Cons (Rgb (150, 0, 255), Nil)))));;

      let components = 
        fun t ->
          match t with
          ( Red -> (255, 0, 0)
          | Green -> (0, 255, 0)
          | Blue -> (0, 0, 255)
          | Yellow -> (255, 255, 0)
          | Rgb c -> c
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: color
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Red
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Green
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Yellow
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Blue
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                └──Constructor declaration:
                   └──Constructor name: Rgb
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: color
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 3873
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3873
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 3873
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 3873
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 3873
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 3873
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: color
                   └──Desc: Variable: cols
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: color
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Cons
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: color
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: color
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: color
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: color
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: color
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: color
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Red
                                        └──Constructor type:
                                           └──Type expr: Constructor: color
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: color
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: color
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: color
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: color
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: color
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: color
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Red
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: color
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: color
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: color
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: color
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: color
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: color
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: color
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: color
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Green
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: color
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: color
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: color
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: color
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: color
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: color
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: color
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: color
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Yellow
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: color
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: color
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Cons
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Constructor: color
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Constructor: color
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: color
                                                                         └──Expression:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: color
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: color
                                                                            └──Desc: Tuple
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: color
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Rgb
                                                                                        └──Constructor argument type:
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Type expr: Constructor: int
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: color
                                                                                     └──Expression:
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: int
                                                                                        └──Desc: Tuple
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Desc: Constant: 150
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Desc: Constant: 0
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: int
                                                                                              └──Desc: Constant: 255
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: list
                                                                                     └──Type expr: Constructor: color
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Nil
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: list
                                                                                              └──Type expr: Constructor: color
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: color
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                   └──Desc: Variable: components
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: color
                         └──Type expr: Tuple
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: color
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: color
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: color
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: color
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Red
                                              └──Constructor type:
                                                 └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 255
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: color
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Green
                                              └──Constructor type:
                                                 └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 255
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: color
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Blue
                                              └──Constructor type:
                                                 └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 255
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: color
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Yellow
                                              └──Constructor type:
                                                 └──Type expr: Constructor: color
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 255
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 255
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: color
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Rgb
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: color
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Variable: c
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: c |}]

let%expect_test "" =
  let str = 
    {|
      type 'a option = 
        | None
        | Some of 'a
      ;;

      let nothing = None;;

      let number = Some 50;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let numbers = Cons (Some 12, Cons (None, Cons (None, Cons (Some 2, Nil))));;

      let word = Some (Cons ('c', Cons ('a', Cons ('k', Cons ('e', Nil)))));;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: option
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: None
                   └──Constructor alphas: 4038
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4038
                └──Constructor declaration:
                   └──Constructor name: Some
                   └──Constructor alphas: 4038
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4038
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Variable: 4038
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: option
                      └──Type expr: Variable: 4047
                   └──Desc: Variable: nothing
                └──Abstraction:
                   └──Variables: 4047
                   └──Expression:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4047
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: None
                            └──Constructor type:
                               └──Type expr: Constructor: option
                                  └──Type expr: Variable: 4047
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: option
                      └──Type expr: Constructor: int
                   └──Desc: Variable: number
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: option
                         └──Type expr: Constructor: int
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Some
                            └──Constructor argument type:
                               └──Type expr: Constructor: int
                            └──Constructor type:
                               └──Type expr: Constructor: option
                                  └──Type expr: Constructor: int
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 50
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 4041
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 4041
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 4041
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 4041
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 4041
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 4041
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: list
                      └──Type expr: Constructor: option
                         └──Type expr: Constructor: int
                   └──Desc: Variable: numbers
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: option
                            └──Type expr: Constructor: int
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Cons
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: option
                                     └──Type expr: Constructor: int
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: option
                                        └──Type expr: Constructor: int
                            └──Constructor type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: option
                                     └──Type expr: Constructor: int
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: option
                                  └──Type expr: Constructor: int
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: option
                                     └──Type expr: Constructor: int
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Constructor: int
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Some
                                        └──Constructor argument type:
                                           └──Type expr: Constructor: int
                                        └──Constructor type:
                                           └──Type expr: Constructor: option
                                              └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 12
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: option
                                        └──Type expr: Constructor: int
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Cons
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Constructor: int
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: option
                                                    └──Type expr: Constructor: int
                                        └──Constructor type:
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Constructor: int
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: option
                                              └──Type expr: Constructor: int
                                           └──Type expr: Constructor: list
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Constructor: int
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Constructor: int
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: None
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Constructor: int
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Constructor: option
                                                    └──Type expr: Constructor: int
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: option
                                                                └──Type expr: Constructor: int
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Constructor: int
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Constructor: int
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: None
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: option
                                                                      └──Type expr: Constructor: int
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Constructor: option
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Cons
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: option
                                                                         └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: option
                                                                            └──Type expr: Constructor: int
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: option
                                                                         └──Type expr: Constructor: int
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: option
                                                                      └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Constructor: option
                                                                         └──Type expr: Constructor: int
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: option
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Some
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Constructor: int
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: option
                                                                                  └──Type expr: Constructor: int
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Constant: 2
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Constructor: option
                                                                            └──Type expr: Constructor: int
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Nil
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: list
                                                                                  └──Type expr: Constructor: option
                                                                                     └──Type expr: Constructor: int
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: option
                      └──Type expr: Constructor: list
                         └──Type expr: Constructor: char
                   └──Desc: Variable: word
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: option
                         └──Type expr: Constructor: list
                            └──Type expr: Constructor: char
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Some
                            └──Constructor argument type:
                               └──Type expr: Constructor: list
                                  └──Type expr: Constructor: char
                            └──Constructor type:
                               └──Type expr: Constructor: option
                                  └──Type expr: Constructor: list
                                     └──Type expr: Constructor: char
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Constructor: char
                            └──Desc: Construct
                               └──Constructor description:
                                  └──Name: Cons
                                  └──Constructor argument type:
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: char
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: char
                                  └──Constructor type:
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: char
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: char
                                     └──Type expr: Constructor: list
                                        └──Type expr: Constructor: char
                                  └──Desc: Tuple
                                     └──Expression:
                                        └──Type expr: Constructor: char
                                        └──Desc: Constant: c
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Constructor: char
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: char
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: char
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: char
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: char
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Constructor: char
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Constructor: char
                                                    └──Desc: Constant: a
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Constructor: char
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: char
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Constructor: char
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: char
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: char
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Constructor: char
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Constructor: char
                                                                └──Desc: Constant: k
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Constructor: char
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Cons
                                                                      └──Constructor argument type:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Constructor: char
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Constructor: char
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Constructor: char
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: char
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Constructor: char
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: char
                                                                            └──Desc: Constant: e
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: list
                                                                               └──Type expr: Constructor: char
                                                                            └──Desc: Construct
                                                                               └──Constructor description:
                                                                                  └──Name: Nil
                                                                                  └──Constructor type:
                                                                                     └──Type expr: Constructor: list
                                                                                        └──Type expr: Constructor: char |}]

let%expect_test "" =
  let str = 
    {|
      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      external eq : 'a. 'a -> 'a -> bool = "%equal";;

      type 'a option = 
        | None
        | Some of 'a
      ;;
      
      let rec find = 
        fun t k ->
          match t with
          ( Nil -> None
          | Cons ((k', d), t) -> if eq k k' then Some d else find t k
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 4179
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 4179
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 4179
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 4179
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 4179
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 4179
       └──Structure item: Primitive
          └──Value description:
             └──Name: eq
             └──Scheme:
                └──Variables: 4187
                └──Type expr: Arrow
                   └──Type expr: Variable: 4187
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4187
                      └──Type expr: Constructor: bool
             └──Primitive name: %equal
       └──Structure item: Type
          └──Type declaration:
             └──Type name: option
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: None
                   └──Constructor alphas: 4184
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4184
                └──Constructor declaration:
                   └──Constructor name: Some
                   └──Constructor alphas: 4184
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4184
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Variable: 4184
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: find
                └──Abstraction:
                   └──Variables: 4237,4240
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Variable: 4240
                               └──Type expr: Variable: 4237
                         └──Type expr: Arrow
                            └──Type expr: Variable: 4240
                            └──Type expr: Constructor: option
                               └──Type expr: Variable: 4237
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 4240
                                  └──Type expr: Variable: 4237
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 4240
                               └──Type expr: Constructor: option
                                  └──Type expr: Variable: 4237
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 4240
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Variable: 4237
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 4240
                                              └──Type expr: Variable: 4237
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 4240
                                           └──Type expr: Variable: 4237
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 4240
                                                    └──Type expr: Variable: 4237
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Variable: 4237
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 4237
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: None
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 4237
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 4240
                                                    └──Type expr: Variable: 4237
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Variable: 4237
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4240
                                                                └──Type expr: Variable: 4237
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Variable: 4237
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 4240
                                                          └──Type expr: Variable: 4237
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Variable: 4237
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Variable: 4237
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 4240
                                                                └──Desc: Variable: k'
                                                             └──Pattern:
                                                                └──Type expr: Variable: 4237
                                                                └──Desc: Variable: d
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4240
                                                                └──Type expr: Variable: 4237
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 4237
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4240
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 4240
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: eq
                                                                   └──Type expr: Variable: 4240
                                                             └──Expression:
                                                                └──Type expr: Variable: 4240
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Variable: 4240
                                                          └──Desc: Variable
                                                             └──Variable: k'
                                                 └──Expression:
                                                    └──Type expr: Constructor: option
                                                       └──Type expr: Variable: 4237
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Some
                                                          └──Constructor argument type:
                                                             └──Type expr: Variable: 4237
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: option
                                                                └──Type expr: Variable: 4237
                                                       └──Expression:
                                                          └──Type expr: Variable: 4237
                                                          └──Desc: Variable
                                                             └──Variable: d
                                                 └──Expression:
                                                    └──Type expr: Constructor: option
                                                       └──Type expr: Variable: 4237
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 4240
                                                             └──Type expr: Constructor: option
                                                                └──Type expr: Variable: 4237
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 4240
                                                                         └──Type expr: Variable: 4237
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 4240
                                                                      └──Type expr: Constructor: option
                                                                         └──Type expr: Variable: 4237
                                                                └──Desc: Variable
                                                                   └──Variable: find
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 4240
                                                                      └──Type expr: Variable: 4237
                                                                └──Desc: Variable
                                                                   └──Variable: t
                                                       └──Expression:
                                                          └──Type expr: Variable: 4240
                                                          └──Desc: Variable
                                                             └──Variable: k |}]

let%expect_test "" =
  let str = 
    {|
      type expr = 
        | Num of int
        | Add of expr * expr
        | Sub of expr * expr
        | Mul of expr * expr
        | Div of expr * expr
      ;;

      let _ = Add (Num 1, Mul (Num 2, Num 3));;

      let rec eval = 
        fun e ->
          match e with
          ( Num n -> n
          | Add (e1, e2) -> eval e1 + eval e2
          | Sub (e1, e2) -> eval e1 - eval e2
          | Mul (e1, e2) -> eval e1 * eval e2
          | Div (e1, e2) -> eval e1 / eval e2
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: expr
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Num
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: expr
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Constructor: int
                └──Constructor declaration:
                   └──Constructor name: Add
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: expr
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: expr
                         └──Type expr: Constructor: expr
                └──Constructor declaration:
                   └──Constructor name: Sub
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: expr
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: expr
                         └──Type expr: Constructor: expr
                └──Constructor declaration:
                   └──Constructor name: Mul
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: expr
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: expr
                         └──Type expr: Constructor: expr
                └──Constructor declaration:
                   └──Constructor name: Div
                   └──Constructor alphas:
                   └──Constructor type:
                      └──Type expr: Constructor: expr
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: expr
                         └──Type expr: Constructor: expr
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: expr
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: expr
                      └──Desc: Construct
                         └──Constructor description:
                            └──Name: Add
                            └──Constructor argument type:
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: expr
                                  └──Type expr: Constructor: expr
                            └──Constructor type:
                               └──Type expr: Constructor: expr
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: expr
                               └──Type expr: Constructor: expr
                            └──Desc: Tuple
                               └──Expression:
                                  └──Type expr: Constructor: expr
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Num
                                        └──Constructor argument type:
                                           └──Type expr: Constructor: int
                                        └──Constructor type:
                                           └──Type expr: Constructor: expr
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
                               └──Expression:
                                  └──Type expr: Constructor: expr
                                  └──Desc: Construct
                                     └──Constructor description:
                                        └──Name: Mul
                                        └──Constructor argument type:
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: expr
                                              └──Type expr: Constructor: expr
                                        └──Constructor type:
                                           └──Type expr: Constructor: expr
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: expr
                                           └──Type expr: Constructor: expr
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: expr
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Num
                                                    └──Constructor argument type:
                                                       └──Type expr: Constructor: int
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: expr
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 2
                                           └──Expression:
                                              └──Type expr: Constructor: expr
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Num
                                                    └──Constructor argument type:
                                                       └──Type expr: Constructor: int
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: expr
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 3
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: eval
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: expr
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: expr
                            └──Desc: Variable: e
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: expr
                                  └──Desc: Variable
                                     └──Variable: e
                               └──Type expr: Constructor: expr
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: expr
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Num
                                              └──Constructor argument type:
                                                 └──Type expr: Constructor: int
                                              └──Constructor type:
                                                 └──Type expr: Constructor: expr
                                           └──Pattern:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable: n
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: n
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: expr
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Add
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: expr
                                                    └──Type expr: Constructor: expr
                                              └──Constructor type:
                                                 └──Type expr: Constructor: expr
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: expr
                                                 └──Type expr: Constructor: expr
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e1
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: expr
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: eval
                                                       └──Expression:
                                                          └──Type expr: Constructor: expr
                                                          └──Desc: Variable
                                                             └──Variable: e1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: expr
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: eval
                                                 └──Expression:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable
                                                       └──Variable: e2
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: expr
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Sub
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: expr
                                                    └──Type expr: Constructor: expr
                                              └──Constructor type:
                                                 └──Type expr: Constructor: expr
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: expr
                                                 └──Type expr: Constructor: expr
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e1
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (-)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: expr
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: eval
                                                       └──Expression:
                                                          └──Type expr: Constructor: expr
                                                          └──Desc: Variable
                                                             └──Variable: e1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: expr
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: eval
                                                 └──Expression:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable
                                                       └──Variable: e2
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: expr
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Mul
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: expr
                                                    └──Type expr: Constructor: expr
                                              └──Constructor type:
                                                 └──Type expr: Constructor: expr
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: expr
                                                 └──Type expr: Constructor: expr
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e1
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (*)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: expr
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: eval
                                                       └──Expression:
                                                          └──Type expr: Constructor: expr
                                                          └──Desc: Variable
                                                             └──Variable: e1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: expr
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: eval
                                                 └──Expression:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable
                                                       └──Variable: e2
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: expr
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Div
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: expr
                                                    └──Type expr: Constructor: expr
                                              └──Constructor type:
                                                 └──Type expr: Constructor: expr
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: expr
                                                 └──Type expr: Constructor: expr
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e1
                                                 └──Pattern:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable: e2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (/)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: expr
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: eval
                                                       └──Expression:
                                                          └──Type expr: Constructor: expr
                                                          └──Desc: Variable
                                                             └──Variable: e1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: expr
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: eval
                                                 └──Expression:
                                                    └──Type expr: Constructor: expr
                                                    └──Desc: Variable
                                                       └──Variable: e2 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a tree = 
        | Br of 'a tree * 'a * 'a tree
        | Lf
      ;;

      let rec size = fun t -> 
        match t with
        ( Br (l, _, r) -> size l + 1 + size r
        | Lf -> 0
        )
      ;;

      let rec sum = 
        fun t ->
          match t with
          ( Br (l, x, r) -> x + sum l + sum r
          | Lf -> 0
          )
      ;;

      external lt : 'a. 'a -> 'a -> bool = "%less_than";;

      let max = fun x y ->
        if lt x y then y else x
      ;;

      let rec depth =
        fun t ->
          match t with
          ( Br (l, _, r) -> 1 + max (depth l) (depth r)
          | Lf -> 0
          )
      ;;

      let rec map = 
        fun t f ->
          match t with
          ( Br (l, x, r) -> Br (map l f, f x, map r f)
          | Lf -> Lf
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: tree
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Br
                   └──Constructor alphas: 4463
                   └──Constructor type:
                      └──Type expr: Constructor: tree
                         └──Type expr: Variable: 4463
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4463
                         └──Type expr: Variable: 4463
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4463
                └──Constructor declaration:
                   └──Constructor name: Lf
                   └──Constructor alphas: 4463
                   └──Constructor type:
                      └──Type expr: Constructor: tree
                         └──Type expr: Variable: 4463
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: size
                └──Abstraction:
                   └──Variables: 4532
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4532
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 4532
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Variable: 4532
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: tree
                                  └──Type expr: Variable: 4532
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4532
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Br
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4532
                                                    └──Type expr: Variable: 4532
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4532
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4532
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4532
                                                 └──Type expr: Variable: 4532
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4532
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4532
                                                    └──Desc: Variable: l
                                                 └──Pattern:
                                                    └──Type expr: Variable: 4532
                                                    └──Desc: Any
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4532
                                                    └──Desc: Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (+)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Variable: 4532
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: size
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Variable: 4532
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                                         └──Type expr: Variable: 4532
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4532
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: size
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4532
                                                    └──Desc: Variable
                                                       └──Variable: r
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4532
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Lf
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4532
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: sum
                └──Abstraction:
                   └──Variables: 4599
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4599
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 4599
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Variable: 4599
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: tree
                                  └──Type expr: Variable: 4599
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4599
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Br
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4599
                                                    └──Type expr: Variable: 4599
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4599
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4599
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4599
                                                 └──Type expr: Variable: 4599
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4599
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4599
                                                    └──Desc: Variable: l
                                                 └──Pattern:
                                                    └──Type expr: Variable: 4599
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4599
                                                    └──Desc: Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (+)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                                   └──Type expr: Constructor: int
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Variable: 4599
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: sum
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Variable: 4599
                                                                └──Desc: Variable
                                                                   └──Variable: l
                                                                   └──Type expr: Variable: 4599
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4599
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: sum
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4599
                                                    └──Desc: Variable
                                                       └──Variable: r
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4599
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Lf
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4599
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 4604
                └──Type expr: Arrow
                   └──Type expr: Variable: 4604
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4604
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4617
                      └──Type expr: Arrow
                         └──Type expr: Variable: 4617
                         └──Type expr: Variable: 4617
                   └──Desc: Variable: max
                └──Abstraction:
                   └──Variables: 4617,4617,4617,4617,4617,4617
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Variable: 4617
                         └──Type expr: Arrow
                            └──Type expr: Variable: 4617
                            └──Type expr: Variable: 4617
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Variable: 4617
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 4617
                               └──Type expr: Variable: 4617
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 4617
                                  └──Desc: Variable: y
                               └──Expression:
                                  └──Type expr: Variable: 4617
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Variable: 4617
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Variable: 4617
                                                       └──Type expr: Arrow
                                                          └──Type expr: Variable: 4617
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Variable
                                                       └──Variable: lt
                                                       └──Type expr: Variable: 4617
                                                 └──Expression:
                                                    └──Type expr: Variable: 4617
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Variable: 4617
                                              └──Desc: Variable
                                                 └──Variable: y
                                     └──Expression:
                                        └──Type expr: Variable: 4617
                                        └──Desc: Variable
                                           └──Variable: y
                                     └──Expression:
                                        └──Type expr: Variable: 4617
                                        └──Desc: Variable
                                           └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: depth
                └──Abstraction:
                   └──Variables: 4688
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4688
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 4688
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Variable: 4688
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: tree
                                  └──Type expr: Variable: 4688
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4688
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Br
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4688
                                                    └──Type expr: Variable: 4688
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4688
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4688
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4688
                                                 └──Type expr: Variable: 4688
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4688
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4688
                                                    └──Desc: Variable: l
                                                 └──Pattern:
                                                    └──Type expr: Variable: 4688
                                                    └──Desc: Any
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 4688
                                                    └──Desc: Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (+)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 1
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: max
                                                             └──Type expr: Constructor: int
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Variable: 4688
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: depth
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Variable: 4688
                                                                └──Desc: Variable
                                                                   └──Variable: l
                                                                   └──Type expr: Variable: 4688
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Variable: 4688
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: depth
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4688
                                                          └──Desc: Variable
                                                             └──Variable: r
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4688
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Lf
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 4688
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: map
                └──Abstraction:
                   └──Variables: 4752,4749
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4749
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 4749
                               └──Type expr: Variable: 4752
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 4752
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 4749
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 4749
                                  └──Type expr: Variable: 4752
                               └──Type expr: Constructor: tree
                                  └──Type expr: Variable: 4752
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 4749
                                     └──Type expr: Variable: 4752
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Variable: 4752
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 4749
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: tree
                                        └──Type expr: Variable: 4749
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Variable: 4749
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Br
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4749
                                                          └──Type expr: Variable: 4749
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4749
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4749
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4749
                                                       └──Type expr: Variable: 4749
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4749
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4749
                                                          └──Desc: Variable: l
                                                       └──Pattern:
                                                          └──Type expr: Variable: 4749
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4749
                                                          └──Desc: Variable: r
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Variable: 4752
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Br
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4752
                                                          └──Type expr: Variable: 4752
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4752
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4752
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4752
                                                       └──Type expr: Variable: 4752
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4752
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4752
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 4749
                                                                      └──Type expr: Variable: 4752
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Variable: 4752
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Variable: 4749
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 4749
                                                                               └──Type expr: Variable: 4752
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Variable: 4752
                                                                      └──Desc: Variable
                                                                         └──Variable: map
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Variable: 4749
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                                         └──Type expr: Variable: 4749
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4749
                                                                   └──Type expr: Variable: 4752
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Variable: 4752
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4749
                                                                   └──Type expr: Variable: 4752
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                             └──Expression:
                                                                └──Type expr: Variable: 4749
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Variable: 4752
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 4749
                                                                      └──Type expr: Variable: 4752
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Variable: 4752
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Variable: 4749
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 4749
                                                                               └──Type expr: Variable: 4752
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Variable: 4752
                                                                      └──Desc: Variable
                                                                         └──Variable: map
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Variable: 4749
                                                                      └──Desc: Variable
                                                                         └──Variable: r
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4749
                                                                   └──Type expr: Variable: 4752
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Variable: 4749
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Lf
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4749
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Variable: 4752
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Lf
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Variable: 4752 |}]

let%expect_test "" =
  let str = 
    {|
      type 'a tree = 
        | Lf
        | Br of 'a tree * 'a * 'a tree
      ;;

      external eq : 'a. 'a -> 'a -> bool = "%equal";;
      external lt : 'a. 'a -> 'a -> bool = "%less_than";;
      external leq : 'a. 'a -> 'a -> bool = "%less_than_equal";;

      type 'a option = 
        | None
        | Some of 'a
      ;;

      let rec find =
        fun t k ->
          match t with
          ( Lf -> None
          | Br (l, (k', d), r) ->
              if eq k k' then Some d
              else if lt k k' then find l k
              else find r k 
          )
      ;;

      let rec add = 
        fun t k d ->
          match t with
          ( Lf -> Br (Lf, (k, d), Lf)
          | Br (l, (k', d'), r) ->
              if eq k k' then Br (l, (k, d), r)
              else if lt k k' then Br (add l k d, (k', d'), r)
              else Br (l, (k', d'), add r k d)   
          )
      ;; 


      let gt = fun x y -> lt y x;;

      external assert_false : 'a. 'a = "%assert false";;

      external raise : 'a. exn -> 'a = "%raise";;
      exception Empty_tree;;

      let rec min_key = 
        fun t -> 
          match t with
          ( Lf -> raise Empty_tree
          | Br (Lf, x, _) -> x
          | Br (l, _, _) -> min_key l
          )
      ;;

      let rec remove = 
        fun t k ->
          match t with
          ( Lf -> Lf
          | Br (l, (k', _) as x, r) ->
              if lt k k' then Br (remove l k, x, r)
              else if gt k k' then Br (l, x, remove r k)
              else
                match t with
                ( Br (Lf, _, Lf) -> Lf
                | Br (Lf, _, r) -> r
                | Br (l, _, Lf) -> l
                | Br (l, _, r) ->
                  let ((k', _) as x) = min_key r in
                  let r' = remove r k' in
                  Br (l, x, r)
                | _ -> assert_false
                )
          )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Type
          └──Type declaration:
             └──Type name: tree
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Lf
                   └──Constructor alphas: 4755
                   └──Constructor type:
                      └──Type expr: Constructor: tree
                         └──Type expr: Variable: 4755
                └──Constructor declaration:
                   └──Constructor name: Br
                   └──Constructor alphas: 4755
                   └──Constructor type:
                      └──Type expr: Constructor: tree
                         └──Type expr: Variable: 4755
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4755
                         └──Type expr: Variable: 4755
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 4755
       └──Structure item: Primitive
          └──Value description:
             └──Name: eq
             └──Scheme:
                └──Variables: 4765
                └──Type expr: Arrow
                   └──Type expr: Variable: 4765
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4765
                      └──Type expr: Constructor: bool
             └──Primitive name: %equal
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 4772
                └──Type expr: Arrow
                   └──Type expr: Variable: 4772
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4772
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Primitive
          └──Value description:
             └──Name: leq
             └──Scheme:
                └──Variables: 4779
                └──Type expr: Arrow
                   └──Type expr: Variable: 4779
                   └──Type expr: Arrow
                      └──Type expr: Variable: 4779
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than_equal
       └──Structure item: Type
          └──Type declaration:
             └──Type name: option
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: None
                   └──Constructor alphas: 4761
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4761
                └──Constructor declaration:
                   └──Constructor name: Some
                   └──Constructor alphas: 4761
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 4761
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Variable: 4761
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: find
                └──Abstraction:
                   └──Variables: 4832,4854
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Tuple
                               └──Type expr: Variable: 4854
                               └──Type expr: Variable: 4832
                         └──Type expr: Arrow
                            └──Type expr: Variable: 4854
                            └──Type expr: Constructor: option
                               └──Type expr: Variable: 4832
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 4854
                                  └──Type expr: Variable: 4832
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 4854
                               └──Type expr: Constructor: option
                                  └──Type expr: Variable: 4832
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 4854
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Variable: 4832
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 4854
                                              └──Type expr: Variable: 4832
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: tree
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 4854
                                           └──Type expr: Variable: 4832
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 4854
                                                    └──Type expr: Variable: 4832
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Lf
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 4832
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: None
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 4832
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 4854
                                                    └──Type expr: Variable: 4832
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Br
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4854
                                                                └──Type expr: Variable: 4832
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4854
                                                                └──Type expr: Variable: 4832
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 4854
                                                          └──Type expr: Variable: 4832
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4854
                                                                └──Type expr: Variable: 4832
                                                          └──Desc: Variable: l
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Variable: 4832
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Variable: 4854
                                                                └──Desc: Variable: k'
                                                             └──Pattern:
                                                                └──Type expr: Variable: 4832
                                                                └──Desc: Variable: d
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 4854
                                                                └──Type expr: Variable: 4832
                                                          └──Desc: Variable: r
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 4832
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 4854
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4854
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 4854
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: eq
                                                                   └──Type expr: Variable: 4854
                                                             └──Expression:
                                                                └──Type expr: Variable: 4854
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Variable: 4854
                                                          └──Desc: Variable
                                                             └──Variable: k'
                                                 └──Expression:
                                                    └──Type expr: Constructor: option
                                                       └──Type expr: Variable: 4832
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Some
                                                          └──Constructor argument type:
                                                             └──Type expr: Variable: 4832
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: option
                                                                └──Type expr: Variable: 4832
                                                       └──Expression:
                                                          └──Type expr: Variable: 4832
                                                          └──Desc: Variable
                                                             └──Variable: d
                                                 └──Expression:
                                                    └──Type expr: Constructor: option
                                                       └──Type expr: Variable: 4832
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4854
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 4854
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 4854
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Variable
                                                                         └──Variable: lt
                                                                         └──Type expr: Variable: 4854
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 4854
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                             └──Expression:
                                                                └──Type expr: Variable: 4854
                                                                └──Desc: Variable
                                                                   └──Variable: k'
                                                       └──Expression:
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Variable: 4832
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4854
                                                                   └──Type expr: Constructor: option
                                                                      └──Type expr: Variable: 4832
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 4854
                                                                               └──Type expr: Variable: 4832
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 4854
                                                                            └──Type expr: Constructor: option
                                                                               └──Type expr: Variable: 4832
                                                                      └──Desc: Variable
                                                                         └──Variable: find
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 4854
                                                                            └──Type expr: Variable: 4832
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                             └──Expression:
                                                                └──Type expr: Variable: 4854
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Constructor: option
                                                             └──Type expr: Variable: 4832
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 4854
                                                                   └──Type expr: Constructor: option
                                                                      └──Type expr: Variable: 4832
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 4854
                                                                               └──Type expr: Variable: 4832
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 4854
                                                                            └──Type expr: Constructor: option
                                                                               └──Type expr: Variable: 4832
                                                                      └──Desc: Variable
                                                                         └──Variable: find
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 4854
                                                                            └──Type expr: Variable: 4832
                                                                      └──Desc: Variable
                                                                         └──Variable: r
                                                             └──Expression:
                                                                └──Type expr: Variable: 4854
                                                                └──Desc: Variable
                                                                   └──Variable: k
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: add
                └──Abstraction:
                   └──Variables: 5012,5015
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Tuple
                               └──Type expr: Variable: 5015
                               └──Type expr: Variable: 5012
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5015
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5012
                               └──Type expr: Constructor: tree
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 5015
                                     └──Type expr: Variable: 5012
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 5015
                                  └──Type expr: Variable: 5012
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5015
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 5012
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Tuple
                                        └──Type expr: Variable: 5015
                                        └──Type expr: Variable: 5012
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 5015
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 5012
                                     └──Type expr: Constructor: tree
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 5015
                                           └──Type expr: Variable: 5012
                                  └──Desc: Function
                                     └──Pattern:
                                        └──Type expr: Variable: 5012
                                        └──Desc: Variable: d
                                     └──Expression:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 5015
                                              └──Type expr: Variable: 5012
                                        └──Desc: Match
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 5015
                                                    └──Type expr: Variable: 5012
                                              └──Desc: Variable
                                                 └──Variable: t
                                           └──Type expr: Constructor: tree
                                              └──Type expr: Tuple
                                                 └──Type expr: Variable: 5015
                                                 └──Type expr: Variable: 5012
                                           └──Cases:
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5015
                                                          └──Type expr: Variable: 5012
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Lf
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5015
                                                          └──Type expr: Variable: 5012
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Br
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5015
                                                                └──Type expr: Variable: 5012
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Lf
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5015
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5012
                                                                      └──Desc: Variable
                                                                         └──Variable: d
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Lf
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                              └──Case:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5015
                                                          └──Type expr: Variable: 5012
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Br
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5015
                                                                └──Type expr: Variable: 5012
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                          └──Desc: Tuple
                                                             └──Pattern:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Variable: l
                                                             └──Pattern:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Variable: 5012
                                                                └──Desc: Tuple
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 5015
                                                                      └──Desc: Variable: k'
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 5012
                                                                      └──Desc: Variable: d'
                                                             └──Pattern:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Variable: r
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5015
                                                          └──Type expr: Variable: 5012
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5015
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Variable
                                                                         └──Variable: eq
                                                                         └──Type expr: Variable: 5015
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5015
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                             └──Expression:
                                                                └──Type expr: Variable: 5015
                                                                └──Desc: Variable
                                                                   └──Variable: k'
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5015
                                                                └──Type expr: Variable: 5012
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Br
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Variable: 5012
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Variable: 5012
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Variable: 5012
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Variable: 5012
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Variable: 5012
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 5015
                                                                            └──Desc: Variable
                                                                               └──Variable: k
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 5012
                                                                            └──Desc: Variable
                                                                               └──Variable: d
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                      └──Desc: Variable
                                                                         └──Variable: r
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5015
                                                                └──Type expr: Variable: 5012
                                                          └──Desc: If
                                                             └──Expression:
                                                                └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 5015
                                                                         └──Type expr: Constructor: bool
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Constructor: bool
                                                                            └──Desc: Variable
                                                                               └──Variable: lt
                                                                               └──Type expr: Variable: 5015
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 5015
                                                                            └──Desc: Variable
                                                                               └──Variable: k
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5015
                                                                      └──Desc: Variable
                                                                         └──Variable: k'
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Br
                                                                      └──Constructor argument type:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 5012
                                                                                     └──Type expr: Constructor: tree
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Variable: 5015
                                                                                           └──Type expr: Variable: 5012
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 5015
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 5012
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Variable: 5012
                                                                                        └──Desc: Application
                                                                                           └──Expression:
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: tree
                                                                                                    └──Type expr: Tuple
                                                                                                       └──Type expr: Variable: 5015
                                                                                                       └──Type expr: Variable: 5012
                                                                                                 └──Type expr: Arrow
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Variable: 5012
                                                                                                       └──Type expr: Constructor: tree
                                                                                                          └──Type expr: Tuple
                                                                                                             └──Type expr: Variable: 5015
                                                                                                             └──Type expr: Variable: 5012
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: add
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Variable: 5012
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: l
                                                                                     └──Expression:
                                                                                        └──Type expr: Variable: 5015
                                                                                        └──Desc: Variable
                                                                                           └──Variable: k
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5012
                                                                                  └──Desc: Variable
                                                                                     └──Variable: d
                                                                         └──Expression:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                            └──Desc: Tuple
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Desc: Variable
                                                                                     └──Variable: k'
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5012
                                                                                  └──Desc: Variable
                                                                                     └──Variable: d'
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Desc: Variable
                                                                               └──Variable: r
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5015
                                                                      └──Type expr: Variable: 5012
                                                                └──Desc: Construct
                                                                   └──Constructor description:
                                                                      └──Name: Br
                                                                      └──Constructor argument type:
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                      └──Constructor type:
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5015
                                                                            └──Type expr: Variable: 5012
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                      └──Desc: Tuple
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Desc: Variable
                                                                               └──Variable: l
                                                                         └──Expression:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5015
                                                                               └──Type expr: Variable: 5012
                                                                            └──Desc: Tuple
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Desc: Variable
                                                                                     └──Variable: k'
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5012
                                                                                  └──Desc: Variable
                                                                                     └──Variable: d'
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5015
                                                                                  └──Type expr: Variable: 5012
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Variable: 5012
                                                                                     └──Type expr: Constructor: tree
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Variable: 5015
                                                                                           └──Type expr: Variable: 5012
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Variable: 5015
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Variable: 5012
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Variable: 5012
                                                                                        └──Desc: Application
                                                                                           └──Expression:
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: tree
                                                                                                    └──Type expr: Tuple
                                                                                                       └──Type expr: Variable: 5015
                                                                                                       └──Type expr: Variable: 5012
                                                                                                 └──Type expr: Arrow
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Variable: 5012
                                                                                                       └──Type expr: Constructor: tree
                                                                                                          └──Type expr: Tuple
                                                                                                             └──Type expr: Variable: 5015
                                                                                                             └──Type expr: Variable: 5012
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: add
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5015
                                                                                                    └──Type expr: Variable: 5012
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: r
                                                                                     └──Expression:
                                                                                        └──Type expr: Variable: 5015
                                                                                        └──Desc: Variable
                                                                                           └──Variable: k
                                                                               └──Expression:
                                                                                  └──Type expr: Variable: 5012
                                                                                  └──Desc: Variable
                                                                                     └──Variable: d
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Variable: 5031
                      └──Type expr: Arrow
                         └──Type expr: Variable: 5031
                         └──Type expr: Constructor: bool
                   └──Desc: Variable: gt
                └──Abstraction:
                   └──Variables: 5031,5031,5031,5031,5031
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Variable: 5031
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5031
                            └──Type expr: Constructor: bool
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Variable: 5031
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5031
                               └──Type expr: Constructor: bool
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 5031
                                  └──Desc: Variable: y
                               └──Expression:
                                  └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Variable: 5031
                                           └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Variable: 5031
                                                 └──Type expr: Arrow
                                                    └──Type expr: Variable: 5031
                                                    └──Type expr: Constructor: bool
                                              └──Desc: Variable
                                                 └──Variable: lt
                                                 └──Type expr: Variable: 5031
                                           └──Expression:
                                              └──Type expr: Variable: 5031
                                              └──Desc: Variable
                                                 └──Variable: y
                                     └──Expression:
                                        └──Type expr: Variable: 5031
                                        └──Desc: Variable
                                           └──Variable: x
       └──Structure item: Primitive
          └──Value description:
             └──Name: assert_false
             └──Scheme:
                └──Variables: 5041
                └──Type expr: Variable: 5041
             └──Primitive name: %assert false
       └──Structure item: Primitive
          └──Value description:
             └──Name: raise
             └──Scheme:
                └──Variables: 5042
                └──Type expr: Arrow
                   └──Type expr: Constructor: exn
                   └──Type expr: Variable: 5042
             └──Primitive name: %raise
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Empty_tree
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: min_key
                └──Abstraction:
                   └──Variables: 5081
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Variable: 5081
                         └──Type expr: Variable: 5081
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Variable: 5081
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Variable: 5081
                            └──Desc: Match
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Variable: 5081
                                  └──Desc: Variable
                                     └──Variable: t
                               └──Type expr: Constructor: tree
                                  └──Type expr: Variable: 5081
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 5081
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Lf
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                     └──Expression:
                                        └──Type expr: Variable: 5081
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: exn
                                                 └──Type expr: Variable: 5081
                                              └──Desc: Variable
                                                 └──Variable: raise
                                                 └──Type expr: Variable: 5081
                                           └──Expression:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Empty_tree
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 5081
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Br
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Type expr: Variable: 5081
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                                 └──Type expr: Variable: 5081
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Lf
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Variable: 5081
                                                 └──Pattern:
                                                    └──Type expr: Variable: 5081
                                                    └──Desc: Variable: x
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Variable: 5081
                                        └──Desc: Variable
                                           └──Variable: x
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Variable: 5081
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Br
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Type expr: Variable: 5081
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                              └──Constructor type:
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                                 └──Type expr: Variable: 5081
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                              └──Desc: Tuple
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Desc: Variable: l
                                                 └──Pattern:
                                                    └──Type expr: Variable: 5081
                                                    └──Desc: Any
                                                 └──Pattern:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Variable: 5081
                                                    └──Desc: Any
                                     └──Expression:
                                        └──Type expr: Variable: 5081
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: tree
                                                    └──Type expr: Variable: 5081
                                                 └──Type expr: Variable: 5081
                                              └──Desc: Variable
                                                 └──Variable: min_key
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Variable: 5081
                                              └──Desc: Variable
                                                 └──Variable: l
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: remove
                └──Abstraction:
                   └──Variables: 5276,5288
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: tree
                            └──Type expr: Tuple
                               └──Type expr: Variable: 5288
                               └──Type expr: Variable: 5276
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5288
                            └──Type expr: Constructor: tree
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 5288
                                  └──Type expr: Variable: 5276
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: tree
                               └──Type expr: Tuple
                                  └──Type expr: Variable: 5288
                                  └──Type expr: Variable: 5276
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5288
                               └──Type expr: Constructor: tree
                                  └──Type expr: Tuple
                                     └──Type expr: Variable: 5288
                                     └──Type expr: Variable: 5276
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Variable: 5288
                                  └──Desc: Variable: k
                               └──Expression:
                                  └──Type expr: Constructor: tree
                                     └──Type expr: Tuple
                                        └──Type expr: Variable: 5288
                                        └──Type expr: Variable: 5276
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: tree
                                           └──Type expr: Tuple
                                              └──Type expr: Variable: 5288
                                              └──Type expr: Variable: 5276
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: tree
                                        └──Type expr: Tuple
                                           └──Type expr: Variable: 5288
                                           └──Type expr: Variable: 5276
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 5288
                                                    └──Type expr: Variable: 5276
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Lf
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 5288
                                                    └──Type expr: Variable: 5276
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Lf
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 5288
                                                    └──Type expr: Variable: 5276
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Br
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5288
                                                          └──Type expr: Variable: 5276
                                                       └──Type expr: Constructor: tree
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                          └──Desc: Variable: l
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Variable: 5276
                                                          └──Desc: Alias
                                                             └──Pattern:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                                └──Desc: Tuple
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 5288
                                                                      └──Desc: Variable: k'
                                                                   └──Pattern:
                                                                      └──Type expr: Variable: 5276
                                                                      └──Desc: Any
                                                             └──As: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                          └──Desc: Variable: r
                                           └──Expression:
                                              └──Type expr: Constructor: tree
                                                 └──Type expr: Tuple
                                                    └──Type expr: Variable: 5288
                                                    └──Type expr: Variable: 5276
                                              └──Desc: If
                                                 └──Expression:
                                                    └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 5288
                                                             └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Constructor: bool
                                                                └──Desc: Variable
                                                                   └──Variable: lt
                                                                   └──Type expr: Variable: 5288
                                                             └──Expression:
                                                                └──Type expr: Variable: 5288
                                                                └──Desc: Variable
                                                                   └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Variable: 5288
                                                          └──Desc: Variable
                                                             └──Variable: k'
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5288
                                                          └──Type expr: Variable: 5276
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Br
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5288
                                                                               └──Type expr: Variable: 5276
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                            └──Desc: Variable
                                                                               └──Variable: remove
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                            └──Desc: Variable
                                                                               └──Variable: l
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5288
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                                └──Desc: Variable
                                                                   └──Variable: x
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                                └──Desc: Variable
                                                                   └──Variable: r
                                                 └──Expression:
                                                    └──Type expr: Constructor: tree
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5288
                                                          └──Type expr: Variable: 5276
                                                    └──Desc: If
                                                       └──Expression:
                                                          └──Type expr: Constructor: bool
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Constructor: bool
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Constructor: bool
                                                                      └──Desc: Variable
                                                                         └──Variable: gt
                                                                         └──Type expr: Variable: 5288
                                                                   └──Expression:
                                                                      └──Type expr: Variable: 5288
                                                                      └──Desc: Variable
                                                                         └──Variable: k
                                                             └──Expression:
                                                                └──Type expr: Variable: 5288
                                                                └──Desc: Variable
                                                                   └──Variable: k'
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                          └──Desc: Construct
                                                             └──Constructor description:
                                                                └──Name: Br
                                                                └──Constructor argument type:
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Variable: 5276
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                └──Constructor type:
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Variable: 5276
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Variable: 5276
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                                   └──Type expr: Constructor: tree
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Variable: 5276
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                                   └──Expression:
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Variable: 5288
                                                                         └──Type expr: Variable: 5276
                                                                      └──Desc: Variable
                                                                         └──Variable: x
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Variable: 5288
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: tree
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Variable: 5288
                                                                                           └──Type expr: Variable: 5276
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Constructor: tree
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 5288
                                                                                              └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable
                                                                                     └──Variable: remove
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable
                                                                                     └──Variable: r
                                                                         └──Expression:
                                                                            └──Type expr: Variable: 5288
                                                                            └──Desc: Variable
                                                                               └──Variable: k
                                                       └──Expression:
                                                          └──Type expr: Constructor: tree
                                                             └──Type expr: Tuple
                                                                └──Type expr: Variable: 5288
                                                                └──Type expr: Variable: 5276
                                                          └──Desc: Match
                                                             └──Expression:
                                                                └──Type expr: Constructor: tree
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Variable: 5288
                                                                      └──Type expr: Variable: 5276
                                                                └──Desc: Variable
                                                                   └──Variable: t
                                                             └──Type expr: Constructor: tree
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Variable: 5288
                                                                   └──Type expr: Variable: 5276
                                                             └──Cases:
                                                                └──Case:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Br
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                         └──Pattern:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                            └──Desc: Tuple
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Lf
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                               └──Pattern:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Desc: Any
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Lf
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Lf
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                └──Case:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Br
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                         └──Pattern:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                            └──Desc: Tuple
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Lf
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                               └──Pattern:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Desc: Any
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable: r
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Variable
                                                                         └──Variable: r
                                                                └──Case:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Br
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                         └──Pattern:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                            └──Desc: Tuple
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable: l
                                                                               └──Pattern:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Desc: Any
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Lf
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Variable
                                                                         └──Variable: l
                                                                └──Case:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Construct
                                                                         └──Constructor description:
                                                                            └──Name: Br
                                                                            └──Constructor argument type:
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                            └──Constructor type:
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                         └──Pattern:
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                               └──Type expr: Constructor: tree
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                            └──Desc: Tuple
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable: l
                                                                               └──Pattern:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Desc: Any
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Variable: r
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Let
                                                                         └──Value bindings:
                                                                            └──Value binding:
                                                                               └──Pattern:
                                                                                  └──Type expr: Tuple
                                                                                     └──Type expr: Variable: 5288
                                                                                     └──Type expr: Variable: 5276
                                                                                  └──Desc: Alias
                                                                                     └──Pattern:
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Variable: 5288
                                                                                           └──Type expr: Variable: 5276
                                                                                        └──Desc: Tuple
                                                                                           └──Pattern:
                                                                                              └──Type expr: Variable: 5288
                                                                                              └──Desc: Variable: k'
                                                                                           └──Pattern:
                                                                                              └──Type expr: Variable: 5276
                                                                                              └──Desc: Any
                                                                                     └──As: x
                                                                               └──Abstraction:
                                                                                  └──Variables:
                                                                                  └──Expression:
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                     └──Desc: Application
                                                                                        └──Expression:
                                                                                           └──Type expr: Arrow
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Variable: 5276
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                           └──Desc: Variable
                                                                                              └──Variable: min_key
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                        └──Expression:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                           └──Desc: Variable
                                                                                              └──Variable: r
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: tree
                                                                               └──Type expr: Tuple
                                                                                  └──Type expr: Variable: 5288
                                                                                  └──Type expr: Variable: 5276
                                                                            └──Desc: Let
                                                                               └──Value bindings:
                                                                                  └──Value binding:
                                                                                     └──Pattern:
                                                                                        └──Type expr: Constructor: tree
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 5288
                                                                                              └──Type expr: Variable: 5276
                                                                                        └──Desc: Variable: r'
                                                                                     └──Abstraction:
                                                                                        └──Variables:
                                                                                        └──Expression:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                           └──Desc: Application
                                                                                              └──Expression:
                                                                                                 └──Type expr: Arrow
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Constructor: tree
                                                                                                       └──Type expr: Tuple
                                                                                                          └──Type expr: Variable: 5288
                                                                                                          └──Type expr: Variable: 5276
                                                                                                 └──Desc: Application
                                                                                                    └──Expression:
                                                                                                       └──Type expr: Arrow
                                                                                                          └──Type expr: Constructor: tree
                                                                                                             └──Type expr: Tuple
                                                                                                                └──Type expr: Variable: 5288
                                                                                                                └──Type expr: Variable: 5276
                                                                                                          └──Type expr: Arrow
                                                                                                             └──Type expr: Variable: 5288
                                                                                                             └──Type expr: Constructor: tree
                                                                                                                └──Type expr: Tuple
                                                                                                                   └──Type expr: Variable: 5288
                                                                                                                   └──Type expr: Variable: 5276
                                                                                                       └──Desc: Variable
                                                                                                          └──Variable: remove
                                                                                                    └──Expression:
                                                                                                       └──Type expr: Constructor: tree
                                                                                                          └──Type expr: Tuple
                                                                                                             └──Type expr: Variable: 5288
                                                                                                             └──Type expr: Variable: 5276
                                                                                                       └──Desc: Variable
                                                                                                          └──Variable: r
                                                                                              └──Expression:
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Desc: Variable
                                                                                                    └──Variable: k'
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: tree
                                                                                     └──Type expr: Tuple
                                                                                        └──Type expr: Variable: 5288
                                                                                        └──Type expr: Variable: 5276
                                                                                  └──Desc: Construct
                                                                                     └──Constructor description:
                                                                                        └──Name: Br
                                                                                        └──Constructor argument type:
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Variable: 5276
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Variable: 5276
                                                                                        └──Constructor type:
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                     └──Expression:
                                                                                        └──Type expr: Tuple
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                           └──Type expr: Tuple
                                                                                              └──Type expr: Variable: 5288
                                                                                              └──Type expr: Variable: 5276
                                                                                           └──Type expr: Constructor: tree
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                        └──Desc: Tuple
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Variable: 5276
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: l
                                                                                           └──Expression:
                                                                                              └──Type expr: Tuple
                                                                                                 └──Type expr: Variable: 5288
                                                                                                 └──Type expr: Variable: 5276
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: x
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: tree
                                                                                                 └──Type expr: Tuple
                                                                                                    └──Type expr: Variable: 5288
                                                                                                    └──Type expr: Variable: 5276
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: r
                                                                └──Case:
                                                                   └──Pattern:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Any
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: tree
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Variable: 5288
                                                                            └──Type expr: Variable: 5276
                                                                      └──Desc: Variable
                                                                         └──Variable: assert_false
                                                                         └──Type expr: Constructor: tree
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Variable: 5288
                                                                               └──Type expr: Variable: 5276 |}]

let%expect_test "" =
  let str = 
    {|
      external print_int : int -> unit = "%print_int";;
      external print_newline : unit -> unit = "%print_newline";;

      let () = print_int 100;;

      let print_map_entry = 
        fun print (k, d) -> 
          print_int k; 
          print_newline (); 
          print d;
          print_newline ()
      ;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec print_map = 
        fun print t ->
          match t with
          ( Nil -> ()
          | Cons (x, t) ->
            print_map_entry print x;
            print_map print t
          )
      ;;

      let rec iter = 
        fun f t ->
          match t with
          ( Nil -> ()
          | Cons (x, t) -> f x; iter f t
          )
      ;;

      let print_map = 
        fun print -> iter (print_map_entry print)
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_int
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_int
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_newline
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: unit
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_newline
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: unit
                   └──Desc: Constant: ()
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: unit
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: unit
                            └──Desc: Variable
                               └──Variable: print_int
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 100
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Arrow
                         └──Type expr: Variable: 5373
                         └──Type expr: Constructor: unit
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: int
                            └──Type expr: Variable: 5373
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: print_map_entry
                └──Abstraction:
                   └──Variables: 5373,5373
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5373
                            └──Type expr: Constructor: unit
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Variable: 5373
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5373
                               └──Type expr: Constructor: unit
                            └──Desc: Variable: print
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Variable: 5373
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Variable: 5373
                                  └──Desc: Tuple
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable: k
                                     └──Pattern:
                                        └──Type expr: Variable: 5373
                                        └──Desc: Variable: d
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Sequence
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: unit
                                              └──Desc: Variable
                                                 └──Variable: print_int
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: k
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: unit
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: print_newline
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Constant: ()
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 5373
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: print
                                                       └──Expression:
                                                          └──Type expr: Variable: 5373
                                                          └──Desc: Variable
                                                             └──Variable: d
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: unit
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: print_newline
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Constant: ()
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 5312
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5312
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 5312
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5312
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 5312
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 5312
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: print_map
                └──Abstraction:
                   └──Variables: 5420
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5420
                            └──Type expr: Constructor: unit
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Variable: 5420
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5420
                               └──Type expr: Constructor: unit
                            └──Desc: Variable: print
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Variable: 5420
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Variable: 5420
                                  └──Desc: Variable: t
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Variable: 5420
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Variable: 5420
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Variable: 5420
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Constant: ()
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Variable: 5420
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Variable: 5420
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Variable: 5420
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Variable: 5420
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Variable: 5420
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 5420
                                                                      └──Type expr: Constructor: unit
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Variable: 5420
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print_map_entry
                                                                   └──Type expr: Variable: 5420
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5420
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Variable: 5420
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Variable: 5420
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 5420
                                                                      └──Type expr: Constructor: unit
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Tuple
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Variable: 5420
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print_map
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5420
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Variable: 5420
                                                          └──Desc: Variable
                                                             └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: iter
                └──Abstraction:
                   └──Variables: 5461
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5461
                            └──Type expr: Constructor: unit
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 5461
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5461
                               └──Type expr: Constructor: unit
                            └──Desc: Variable: f
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 5461
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 5461
                                  └──Desc: Variable: t
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 5461
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 5461
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 5461
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5461
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Constant: ()
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 5461
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5461
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5461
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5461
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 5461
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5461
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 5461
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5461
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 5461
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Variable: 5461
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 5461
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 5461
                                                                      └──Type expr: Constructor: unit
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 5461
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: iter
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5461
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5461
                                                          └──Desc: Variable
                                                             └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Arrow
                         └──Type expr: Variable: 5491
                         └──Type expr: Constructor: unit
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Variable: 5491
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: print_map
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5491
                            └──Type expr: Constructor: unit
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Variable: 5491
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5491
                               └──Type expr: Constructor: unit
                            └──Desc: Variable: print
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Variable: 5491
                               └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Arrow
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Variable: 5491
                                        └──Type expr: Constructor: unit
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Variable: 5491
                                        └──Type expr: Constructor: unit
                                  └──Desc: Variable
                                     └──Variable: iter
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Variable: 5491
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Variable: 5491
                                     └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Arrow
                                              └──Type expr: Variable: 5491
                                              └──Type expr: Constructor: unit
                                           └──Type expr: Arrow
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Variable: 5491
                                              └──Type expr: Constructor: unit
                                        └──Desc: Variable
                                           └──Variable: print_map_entry
                                           └──Type expr: Variable: 5491
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Variable: 5491
                                           └──Type expr: Constructor: unit
                                        └──Desc: Variable
                                           └──Variable: print |}]

let%expect_test "" =
  let str = 
    {|
      external print_endline : string -> unit = "%print_endline";;
      external read_int : unit -> int = "%read_int";;
      external read_line : unit -> string = "%read_line";;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec read_map =
        fun () -> 
          let i = read_int () in
          if i = 0 then Nil
          else 
            let name = read_line () in
            Cons ((i, name), read_map ())
      ;;

      exception Failure of string;;

      let rec read_map =
        fun () -> 
          try 
            let i = read_int () in
            if i = 0 then Nil
            else 
              let name = read_line () in
              Cons ((i, name), read_map ())
          with
            ( Failure "int_of_string" ->
                print_endline "Invalid int";
                read_map ()
            )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_endline
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_endline
       └──Structure item: Primitive
          └──Value description:
             └──Name: read_int
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: unit
                   └──Type expr: Constructor: int
             └──Primitive name: %read_int
       └──Structure item: Primitive
          └──Value description:
             └──Name: read_line
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: unit
                   └──Type expr: Constructor: string
             └──Primitive name: %read_line
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 5497
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5497
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 5497
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5497
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 5497
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 5497
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: read_map
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: unit
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: unit
                            └──Desc: Constant: ()
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable: i
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: unit
                                                    └──Type expr: Constructor: int
                                                 └──Desc: Variable
                                                    └──Variable: read_int
                                              └──Expression:
                                                 └──Type expr: Constructor: unit
                                                 └──Desc: Constant: ()
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Primitive: (=)
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: i
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Constant: 0
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Let
                                           └──Value bindings:
                                              └──Value binding:
                                                 └──Pattern:
                                                    └──Type expr: Constructor: string
                                                    └──Desc: Variable: name
                                                 └──Abstraction:
                                                    └──Variables:
                                                    └──Expression:
                                                       └──Type expr: Constructor: string
                                                       └──Desc: Application
                                                          └──Expression:
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: unit
                                                                └──Type expr: Constructor: string
                                                             └──Desc: Variable
                                                                └──Variable: read_line
                                                          └──Expression:
                                                             └──Type expr: Constructor: unit
                                                             └──Desc: Constant: ()
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: string
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: string
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                    └──Desc: Tuple
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: i
                                                             └──Expression:
                                                                └──Type expr: Constructor: string
                                                                └──Desc: Variable
                                                                   └──Variable: name
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: string
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: unit
                                                                   └──Type expr: Constructor: list
                                                                      └──Type expr: Tuple
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: string
                                                                └──Desc: Variable
                                                                   └──Variable: read_map
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Constant: ()
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: Failure
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
                      └──Constructor argument:
                         └──Constructor betas:
                         └──Type expr: Constructor: string
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: read_map
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: unit
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: unit
                            └──Desc: Constant: ()
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Desc: Try
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Constructor: int
                                              └──Desc: Variable: i
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: unit
                                                          └──Type expr: Constructor: int
                                                       └──Desc: Variable
                                                          └──Variable: read_int
                                                    └──Expression:
                                                       └──Type expr: Constructor: unit
                                                       └──Desc: Constant: ()
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: If
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: bool
                                                          └──Desc: Primitive: (=)
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: i
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Constant: 0
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Let
                                                 └──Value bindings:
                                                    └──Value binding:
                                                       └──Pattern:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Variable: name
                                                       └──Abstraction:
                                                          └──Variables:
                                                          └──Expression:
                                                             └──Type expr: Constructor: string
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: unit
                                                                      └──Type expr: Constructor: string
                                                                   └──Desc: Variable
                                                                      └──Variable: read_line
                                                                └──Expression:
                                                                   └──Type expr: Constructor: unit
                                                                   └──Desc: Constant: ()
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: string
                                                    └──Desc: Construct
                                                       └──Constructor description:
                                                          └──Name: Cons
                                                          └──Constructor argument type:
                                                             └──Type expr: Tuple
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: string
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: string
                                                          └──Constructor type:
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: string
                                                       └──Expression:
                                                          └──Type expr: Tuple
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: string
                                                          └──Desc: Tuple
                                                             └──Expression:
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: string
                                                                └──Desc: Tuple
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: i
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: string
                                                                      └──Desc: Variable
                                                                         └──Variable: name
                                                             └──Expression:
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: string
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: unit
                                                                         └──Type expr: Constructor: list
                                                                            └──Type expr: Tuple
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: string
                                                                      └──Desc: Variable
                                                                         └──Variable: read_map
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: unit
                                                                      └──Desc: Constant: ()
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: exn
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Failure
                                              └──Constructor argument type:
                                                 └──Type expr: Constructor: string
                                              └──Constructor type:
                                                 └──Type expr: Constructor: exn
                                           └──Pattern:
                                              └──Type expr: Constructor: string
                                              └──Desc: Constant: int_of_string
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: string
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: print_endline
                                                 └──Expression:
                                                    └──Type expr: Constructor: string
                                                    └──Desc: Constant: Invalid int
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: unit
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                    └──Desc: Variable
                                                       └──Variable: read_map
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Constant: () |}]

let%expect_test "" =
  let str = 
    {|
      external open_out : string -> out_channel = "%open_out";;
      external close_out : out_channel -> unit = "%close_out";;
      external output_string : out_channel -> string -> unit = "%output_string";;
      external output_char : out_channel -> char -> unit = "%output_char";;
      external string_of_int : int -> string = "%string_of_int";;


      let output_entry = 
        fun ch (k, d) ->
          output_string ch (string_of_int k);
          output_char ch '\n';
          output_string ch d;
          output_char ch '\n'
      ;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec iter = 
        fun f t ->
          match t with
          ( Nil -> ()
          | Cons (x, t) -> f x; iter f t
          )
      ;;

      let output_map = 
        fun ch ->
          iter (output_entry ch)
      ;;

      let write_map_to_file =
        fun filename map -> 
          let ch = open_out filename in
          output_map ch map;
          close_out ch
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: open_out
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: out_channel
             └──Primitive name: %open_out
       └──Structure item: Primitive
          └──Value description:
             └──Name: close_out
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: out_channel
                   └──Type expr: Constructor: unit
             └──Primitive name: %close_out
       └──Structure item: Primitive
          └──Value description:
             └──Name: output_string
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: out_channel
                   └──Type expr: Arrow
                      └──Type expr: Constructor: string
                      └──Type expr: Constructor: unit
             └──Primitive name: %output_string
       └──Structure item: Primitive
          └──Value description:
             └──Name: output_char
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: out_channel
                   └──Type expr: Arrow
                      └──Type expr: Constructor: char
                      └──Type expr: Constructor: unit
             └──Primitive name: %output_char
       └──Structure item: Primitive
          └──Value description:
             └──Name: string_of_int
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Constructor: string
             └──Primitive name: %string_of_int
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: out_channel
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: string
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: output_entry
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: out_channel
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: out_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: string
                                  └──Desc: Tuple
                                     └──Pattern:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable: k
                                     └──Pattern:
                                        └──Type expr: Constructor: string
                                        └──Desc: Variable: d
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Sequence
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: string
                                                 └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: out_channel
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: string
                                                          └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: output_string
                                                 └──Expression:
                                                    └──Type expr: Constructor: out_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch
                                           └──Expression:
                                              └──Type expr: Constructor: string
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                                    └──Desc: Variable
                                                       └──Variable: string_of_int
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: k
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: char
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: out_channel
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: char
                                                                └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: output_char
                                                       └──Expression:
                                                          └──Type expr: Constructor: out_channel
                                                          └──Desc: Variable
                                                             └──Variable: ch
                                                 └──Expression:
                                                    └──Type expr: Constructor: char
                                                    └──Desc: Constant:

                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: out_channel
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: string
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: output_string
                                                             └──Expression:
                                                                └──Type expr: Constructor: out_channel
                                                                └──Desc: Variable
                                                                   └──Variable: ch
                                                       └──Expression:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Variable
                                                             └──Variable: d
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: char
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: out_channel
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: char
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: output_char
                                                             └──Expression:
                                                                └──Type expr: Constructor: out_channel
                                                                └──Desc: Variable
                                                                   └──Variable: ch
                                                       └──Expression:
                                                          └──Type expr: Constructor: char
                                                          └──Desc: Constant:

       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 5681
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5681
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 5681
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5681
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 5681
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 5681
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: iter
                └──Abstraction:
                   └──Variables: 5825
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 5825
                            └──Type expr: Constructor: unit
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Variable: 5825
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Arrow
                               └──Type expr: Variable: 5825
                               └──Type expr: Constructor: unit
                            └──Desc: Variable: f
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Variable: 5825
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Variable: 5825
                                  └──Desc: Variable: t
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Variable: 5825
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: list
                                        └──Type expr: Variable: 5825
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 5825
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Nil
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5825
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Constant: ()
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Variable: 5825
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Cons
                                                    └──Constructor argument type:
                                                       └──Type expr: Tuple
                                                          └──Type expr: Variable: 5825
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5825
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5825
                                                 └──Pattern:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Variable: 5825
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Variable: 5825
                                                    └──Desc: Tuple
                                                       └──Pattern:
                                                          └──Type expr: Variable: 5825
                                                          └──Desc: Variable: x
                                                       └──Pattern:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5825
                                                          └──Desc: Variable: t
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 5825
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Variable: 5825
                                                          └──Desc: Variable
                                                             └──Variable: x
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Variable: 5825
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Variable: 5825
                                                                      └──Type expr: Constructor: unit
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: list
                                                                         └──Type expr: Variable: 5825
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: iter
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Variable: 5825
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Variable: 5825
                                                          └──Desc: Variable
                                                             └──Variable: t
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: out_channel
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: output_map
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: out_channel
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: out_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: string
                               └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Arrow
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: string
                                        └──Type expr: Constructor: unit
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Type expr: Constructor: unit
                                  └──Desc: Variable
                                     └──Variable: iter
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                     └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: out_channel
                                           └──Type expr: Arrow
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: string
                                              └──Type expr: Constructor: unit
                                        └──Desc: Variable
                                           └──Variable: output_entry
                                     └──Expression:
                                        └──Type expr: Constructor: out_channel
                                        └──Desc: Variable
                                           └──Variable: ch
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: string
                      └──Type expr: Arrow
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: write_map_to_file
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: string
                         └──Type expr: Arrow
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: string
                            └──Desc: Variable: filename
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: list
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: string
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                  └──Desc: Variable: map
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Constructor: out_channel
                                              └──Desc: Variable: ch
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Constructor: out_channel
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: string
                                                          └──Type expr: Constructor: out_channel
                                                       └──Desc: Variable
                                                          └──Variable: open_out
                                                    └──Expression:
                                                       └──Type expr: Constructor: string
                                                       └──Desc: Variable
                                                          └──Variable: filename
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: list
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: out_channel
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: list
                                                                   └──Type expr: Tuple
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: string
                                                                └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: output_map
                                                       └──Expression:
                                                          └──Type expr: Constructor: out_channel
                                                          └──Desc: Variable
                                                             └──Variable: ch
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: string
                                                    └──Desc: Variable
                                                       └──Variable: map
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: out_channel
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: close_out
                                                 └──Expression:
                                                    └──Type expr: Constructor: out_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch |}]

let%expect_test "" =
  let str = 
    {|
      external open_in : string -> in_channel = "%open_in";;
      external close_in : in_channel -> unit = "%close_in";;
      external input_line : in_channel -> string = "%input_line";;

      external int_of_string : string -> int = "%int_of_string";;

      let read_entry = 
        fun ch ->
          let i = input_line ch in
          let k = input_line ch in
          (int_of_string i, k)
      ;;

      exception End_of_file;;

      type 'a list =
        | Nil
        | Cons of 'a * 'a list
      ;;

      let rec read_map = 
        fun ch ->
          try 
            let entry = read_entry ch in
            Cons (entry, read_map ch)
          with (End_of_file -> Nil)
      ;;

      let read_map_from_file = 
        fun filename ->
          let ch = open_in filename in
          let map = read_map ch in
          close_in ch;
          map
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: open_in
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: in_channel
             └──Primitive name: %open_in
       └──Structure item: Primitive
          └──Value description:
             └──Name: close_in
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: in_channel
                   └──Type expr: Constructor: unit
             └──Primitive name: %close_in
       └──Structure item: Primitive
          └──Value description:
             └──Name: input_line
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: in_channel
                   └──Type expr: Constructor: string
             └──Primitive name: %input_line
       └──Structure item: Primitive
          └──Value description:
             └──Name: int_of_string
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: int
             └──Primitive name: %int_of_string
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: in_channel
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: string
                   └──Desc: Variable: read_entry
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: in_channel
                         └──Type expr: Tuple
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: string
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: in_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: string
                                        └──Desc: Variable: i
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: string
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: in_channel
                                                    └──Type expr: Constructor: string
                                                 └──Desc: Variable
                                                    └──Variable: input_line
                                              └──Expression:
                                                 └──Type expr: Constructor: in_channel
                                                 └──Desc: Variable
                                                    └──Variable: ch
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: string
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Constructor: string
                                              └──Desc: Variable: k
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Constructor: string
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: in_channel
                                                          └──Type expr: Constructor: string
                                                       └──Desc: Variable
                                                          └──Variable: input_line
                                                    └──Expression:
                                                       └──Type expr: Constructor: in_channel
                                                       └──Desc: Variable
                                                          └──Variable: ch
                                     └──Expression:
                                        └──Type expr: Tuple
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: string
                                        └──Desc: Tuple
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: string
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: int_of_string
                                                 └──Expression:
                                                    └──Type expr: Constructor: string
                                                    └──Desc: Variable
                                                       └──Variable: i
                                           └──Expression:
                                              └──Type expr: Constructor: string
                                              └──Desc: Variable
                                                 └──Variable: k
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: End_of_file
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Type
          └──Type declaration:
             └──Type name: list
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: Nil
                   └──Constructor alphas: 5899
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5899
                └──Constructor declaration:
                   └──Constructor name: Cons
                   └──Constructor alphas: 5899
                   └──Constructor type:
                      └──Type expr: Constructor: list
                         └──Type expr: Variable: 5899
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Tuple
                         └──Type expr: Variable: 5899
                         └──Type expr: Constructor: list
                            └──Type expr: Variable: 5899
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Variable: read_map
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: in_channel
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: in_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Desc: Try
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: string
                                              └──Desc: Variable: entry
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: in_channel
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: string
                                                       └──Desc: Variable
                                                          └──Variable: read_entry
                                                    └──Expression:
                                                       └──Type expr: Constructor: in_channel
                                                       └──Desc: Variable
                                                          └──Variable: ch
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Cons
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: string
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                              └──Desc: Tuple
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                                    └──Desc: Variable
                                                       └──Variable: entry
                                                 └──Expression:
                                                    └──Type expr: Constructor: list
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: int
                                                          └──Type expr: Constructor: string
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: in_channel
                                                             └──Type expr: Constructor: list
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: string
                                                          └──Desc: Variable
                                                             └──Variable: read_map
                                                       └──Expression:
                                                          └──Type expr: Constructor: in_channel
                                                          └──Desc: Variable
                                                             └──Variable: ch
                               └──Cases:
                                  └──Case:
                                     └──Pattern:
                                        └──Type expr: Constructor: exn
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: End_of_file
                                              └──Constructor type:
                                                 └──Type expr: Constructor: exn
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Nil
                                              └──Constructor type:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: string
                      └──Type expr: Constructor: list
                         └──Type expr: Tuple
                            └──Type expr: Constructor: int
                            └──Type expr: Constructor: string
                   └──Desc: Variable: read_map_from_file
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: string
                         └──Type expr: Constructor: list
                            └──Type expr: Tuple
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: string
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: string
                            └──Desc: Variable: filename
                         └──Expression:
                            └──Type expr: Constructor: list
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: int
                                  └──Type expr: Constructor: string
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: in_channel
                                        └──Desc: Variable: ch
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: in_channel
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: string
                                                    └──Type expr: Constructor: in_channel
                                                 └──Desc: Variable
                                                    └──Variable: open_in
                                              └──Expression:
                                                 └──Type expr: Constructor: string
                                                 └──Desc: Variable
                                                    └──Variable: filename
                               └──Expression:
                                  └──Type expr: Constructor: list
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: string
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Variable: map
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Constructor: list
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: string
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: in_channel
                                                          └──Type expr: Constructor: list
                                                             └──Type expr: Tuple
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: string
                                                       └──Desc: Variable
                                                          └──Variable: read_map
                                                    └──Expression:
                                                       └──Type expr: Constructor: in_channel
                                                       └──Desc: Variable
                                                          └──Variable: ch
                                     └──Expression:
                                        └──Type expr: Constructor: list
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: string
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: in_channel
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: close_in
                                                 └──Expression:
                                                    └──Type expr: Constructor: in_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch
                                           └──Expression:
                                              └──Type expr: Constructor: list
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: string
                                              └──Desc: Variable
                                                 └──Variable: map |}]

let%expect_test "" =
  let str = 
    {|
      let x = ref 0;;

      let p = !x;;

      let () = x := 50;;

      let q = !x;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: ref
                      └──Type expr: Constructor: int
                   └──Desc: Variable: x
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                            └──Desc: Primitive: ref
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Variable: p
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Primitive: (!)
                         └──Expression:
                            └──Type expr: Constructor: ref
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: unit
                   └──Desc: Constant: ()
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: unit
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: ref
                                        └──Type expr: Constructor: int
                                     └──Type expr: Arrow
                                        └──Type expr: Constructor: int
                                        └──Type expr: Constructor: unit
                                  └──Desc: Primitive: (:=)
                               └──Expression:
                                  └──Type expr: Constructor: ref
                                     └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: x
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 50
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: int
                   └──Desc: Variable: q
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                               └──Type expr: Constructor: int
                            └──Desc: Primitive: (!)
                         └──Expression:
                            └──Type expr: Constructor: ref
                               └──Type expr: Constructor: int
                            └──Desc: Variable
                               └──Variable: x |}]

let%expect_test "" =
  let str = 
    {|
      let swap = 
        fun r1 r2 ->
          let t = !r1 in
          r1 := !r2; 
          r2 := t
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: ref
                         └──Type expr: Variable: 6114
                      └──Type expr: Arrow
                         └──Type expr: Constructor: ref
                            └──Type expr: Variable: 6114
                         └──Type expr: Constructor: unit
                   └──Desc: Variable: swap
                └──Abstraction:
                   └──Variables: 6114,6114,6114,6114,6114,6114,6114
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: ref
                            └──Type expr: Variable: 6114
                         └──Type expr: Arrow
                            └──Type expr: Constructor: ref
                               └──Type expr: Variable: 6114
                            └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: ref
                               └──Type expr: Variable: 6114
                            └──Desc: Variable: r1
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: ref
                                  └──Type expr: Variable: 6114
                               └──Type expr: Constructor: unit
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Constructor: ref
                                     └──Type expr: Variable: 6114
                                  └──Desc: Variable: r2
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Let
                                     └──Value bindings:
                                        └──Value binding:
                                           └──Pattern:
                                              └──Type expr: Variable: 6114
                                              └──Desc: Variable: t
                                           └──Abstraction:
                                              └──Variables:
                                              └──Expression:
                                                 └──Type expr: Variable: 6114
                                                 └──Desc: Application
                                                    └──Expression:
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: ref
                                                             └──Type expr: Variable: 6114
                                                          └──Type expr: Variable: 6114
                                                       └──Desc: Primitive: (!)
                                                    └──Expression:
                                                       └──Type expr: Constructor: ref
                                                          └──Type expr: Variable: 6114
                                                       └──Desc: Variable
                                                          └──Variable: r1
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Variable: 6114
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: ref
                                                                └──Type expr: Variable: 6114
                                                             └──Type expr: Arrow
                                                                └──Type expr: Variable: 6114
                                                                └──Type expr: Constructor: unit
                                                          └──Desc: Primitive: (:=)
                                                       └──Expression:
                                                          └──Type expr: Constructor: ref
                                                             └──Type expr: Variable: 6114
                                                          └──Desc: Variable
                                                             └──Variable: r1
                                                 └──Expression:
                                                    └──Type expr: Variable: 6114
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: ref
                                                                └──Type expr: Variable: 6114
                                                             └──Type expr: Variable: 6114
                                                          └──Desc: Primitive: (!)
                                                       └──Expression:
                                                          └──Type expr: Constructor: ref
                                                             └──Type expr: Variable: 6114
                                                          └──Desc: Variable
                                                             └──Variable: r2
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Variable: 6114
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: ref
                                                                └──Type expr: Variable: 6114
                                                             └──Type expr: Arrow
                                                                └──Type expr: Variable: 6114
                                                                └──Type expr: Constructor: unit
                                                          └──Desc: Primitive: (:=)
                                                       └──Expression:
                                                          └──Type expr: Constructor: ref
                                                             └──Type expr: Variable: 6114
                                                          └──Desc: Variable
                                                             └──Variable: r2
                                                 └──Expression:
                                                    └──Type expr: Variable: 6114
                                                    └──Desc: Variable
                                                       └──Variable: t |}]

let%expect_test "" =
  let str = 
    {|
      let (x, y) = (0, 0);;

      let a = ref 0;;
      let b = ref 0;;
      let c = ref 0;;

      let incr = fun r -> r := !r + 1;;
      let decr = fun r -> r := !r - 1;;

      let _ = 
        if x = y then
          (incr a; decr b)
        else 
          incr c
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Tuple
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Tuple
                      └──Pattern:
                         └──Type expr: Constructor: int
                         └──Desc: Variable: x
                      └──Pattern:
                         └──Type expr: Constructor: int
                         └──Desc: Variable: y
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Tuple
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Tuple
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: ref
                      └──Type expr: Constructor: int
                   └──Desc: Variable: a
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                            └──Desc: Primitive: ref
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: ref
                      └──Type expr: Constructor: int
                   └──Desc: Variable: b
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                            └──Desc: Primitive: ref
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: ref
                      └──Type expr: Constructor: int
                   └──Desc: Variable: c
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Desc: Application
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Constructor: int
                               └──Type expr: Constructor: ref
                                  └──Type expr: Constructor: int
                            └──Desc: Primitive: ref
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Constant: 0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: incr
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: ref
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: ref
                               └──Type expr: Constructor: int
                            └──Desc: Variable: r
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: unit
                                        └──Desc: Primitive: (:=)
                                     └──Expression:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: r
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: ref
                                                          └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (!)
                                                 └──Expression:
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: decr
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: ref
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: ref
                               └──Type expr: Constructor: int
                            └──Desc: Variable: r
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: unit
                                        └──Desc: Primitive: (:=)
                                     └──Expression:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: r
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (-)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: ref
                                                          └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (!)
                                                 └──Expression:
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Constructor: unit
                   └──Desc: Any
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Constructor: unit
                      └──Desc: If
                         └──Expression:
                            └──Type expr: Constructor: bool
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: bool
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: bool
                                        └──Desc: Primitive: (=)
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: x
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: y
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Sequence
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Type expr: Constructor: unit
                                        └──Desc: Variable
                                           └──Variable: incr
                                     └──Expression:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: a
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Type expr: Constructor: unit
                                        └──Desc: Variable
                                           └──Variable: decr
                                     └──Expression:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: b
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: ref
                                        └──Type expr: Constructor: int
                                     └──Type expr: Constructor: unit
                                  └──Desc: Variable
                                     └──Variable: incr
                               └──Expression:
                                  └──Type expr: Constructor: ref
                                     └──Type expr: Constructor: int
                                  └──Desc: Variable
                                     └──Variable: c |}]

let%expect_test "" =
  let str = 
    {|
      external print_int : int -> unit = "%print_int";;
      external print_newline : string -> unit = "%print_newline";;

      let () = 
        for i = 1 to 5 do
          print_int x;
          print_newline ()
        done
      ;;
    |}
  in
  print_infer_result str;
  [%expect {| ("Term variable is unbound when solving constraint" (term_var x)) |}]
  
let%expect_test "" =
  let str = 
    {|
      external lt : 'a. 'a -> 'a -> bool = "%less_than";;
      
      let lg = 
        fun n ->
          let result = ref 1 in
          while lt (!result) n do
            result := !result * 2
          done;
          !result
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: lt
             └──Scheme:
                └──Variables: 6348
                └──Type expr: Arrow
                   └──Type expr: Variable: 6348
                   └──Type expr: Arrow
                      └──Type expr: Variable: 6348
                      └──Type expr: Constructor: bool
             └──Primitive name: %less_than
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: int
                      └──Type expr: Constructor: int
                   └──Desc: Variable: lg
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: int
                         └──Type expr: Constructor: int
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: int
                            └──Desc: Variable: n
                         └──Expression:
                            └──Type expr: Constructor: int
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: result
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 1
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Sequence
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: While
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: bool
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: bool
                                                          └──Desc: Variable
                                                             └──Variable: lt
                                                             └──Type expr: Constructor: int
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: ref
                                                                      └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (!)
                                                             └──Expression:
                                                                └──Type expr: Constructor: ref
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: result
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: n
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: ref
                                                                └──Type expr: Constructor: int
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: int
                                                                └──Type expr: Constructor: unit
                                                          └──Desc: Primitive: (:=)
                                                       └──Expression:
                                                          └──Type expr: Constructor: ref
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Variable
                                                             └──Variable: result
                                                 └──Expression:
                                                    └──Type expr: Constructor: int
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: int
                                                                └──Desc: Primitive: (*)
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: ref
                                                                            └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (!)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: ref
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: result
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Constant: 2
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: ref
                                                    └──Type expr: Constructor: int
                                                 └──Type expr: Constructor: int
                                              └──Desc: Primitive: (!)
                                           └──Expression:
                                              └──Type expr: Constructor: ref
                                                 └──Type expr: Constructor: int
                                              └──Desc: Variable
                                                 └──Variable: result |}]

let%expect_test "" =
  let str = 
    {|
      external print_int : int -> unit = "%print_int";;
      external print_endline : string -> unit = "%print_endline";;
      external print_string : string -> unit = "%print_string";;
      
      external print_newline : unit -> unit = "%print_newline";;

      external open_in : string -> in_channel = "%open_in";;
      external close_in : in_channel -> unit = "%close_in";;
      external input_line : in_channel -> string = "%input_line";;

      exception End_of_file;;

      let read_stats = 
        fun ch ->
          let lines = ref 0 in
          try 
            while true do
              let line = input_line ch in
              lines := !lines + 1
            done
          with 
            (End_of_file ->
              print_string "There were ";
              print_int (!lines);
              print_string " lines.";
              print_newline ()
            )
      ;;

      let read_stats_from_file = 
        fun filename ->
          let ch = open_in filename in
          try 
            (read_stats ch;
            close_in ch)
          with
            ( _ -> close_in ch )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_int
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_int
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_endline
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_endline
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_string
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_string
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_newline
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: unit
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_newline
       └──Structure item: Primitive
          └──Value description:
             └──Name: open_in
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: in_channel
             └──Primitive name: %open_in
       └──Structure item: Primitive
          └──Value description:
             └──Name: close_in
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: in_channel
                   └──Type expr: Constructor: unit
             └──Primitive name: %close_in
       └──Structure item: Primitive
          └──Value description:
             └──Name: input_line
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: in_channel
                   └──Type expr: Constructor: string
             └──Primitive name: %input_line
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: End_of_file
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: in_channel
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: read_stats
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: in_channel
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: in_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: lines
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 0
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Try
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: While
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Constant: true
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Let
                                                 └──Value bindings:
                                                    └──Value binding:
                                                       └──Pattern:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Variable: line
                                                       └──Abstraction:
                                                          └──Variables:
                                                          └──Expression:
                                                             └──Type expr: Constructor: string
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: in_channel
                                                                      └──Type expr: Constructor: string
                                                                   └──Desc: Variable
                                                                      └──Variable: input_line
                                                                └──Expression:
                                                                   └──Type expr: Constructor: in_channel
                                                                   └──Desc: Variable
                                                                      └──Variable: ch
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: int
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: ref
                                                                      └──Type expr: Constructor: int
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: int
                                                                      └──Type expr: Constructor: unit
                                                                └──Desc: Primitive: (:=)
                                                             └──Expression:
                                                                └──Type expr: Constructor: ref
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: lines
                                                       └──Expression:
                                                          └──Type expr: Constructor: int
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: int
                                                                            └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (+)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: ref
                                                                                  └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Primitive: (!)
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: ref
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Variable
                                                                               └──Variable: lines
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Constant: 1
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: End_of_file
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: print_string
                                                       └──Expression:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Constant: There were
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Sequence
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print_int
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: ref
                                                                            └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (!)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: ref
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: lines
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Sequence
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: string
                                                                         └──Type expr: Constructor: unit
                                                                      └──Desc: Variable
                                                                         └──Variable: print_string
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: string
                                                                      └──Desc: Constant:  lines.
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: unit
                                                                         └──Type expr: Constructor: unit
                                                                      └──Desc: Variable
                                                                         └──Variable: print_newline
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: unit
                                                                      └──Desc: Constant: ()
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: string
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: read_stats_from_file
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: string
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: string
                            └──Desc: Variable: filename
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: in_channel
                                        └──Desc: Variable: ch
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: in_channel
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: string
                                                    └──Type expr: Constructor: in_channel
                                                 └──Desc: Variable
                                                    └──Variable: open_in
                                              └──Expression:
                                                 └──Type expr: Constructor: string
                                                 └──Desc: Variable
                                                    └──Variable: filename
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Try
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: Sequence
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: in_channel
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: read_stats
                                                 └──Expression:
                                                    └──Type expr: Constructor: in_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: in_channel
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: close_in
                                                 └──Expression:
                                                    └──Type expr: Constructor: in_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Any
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: in_channel
                                                       └──Type expr: Constructor: unit
                                                    └──Desc: Variable
                                                       └──Variable: close_in
                                                 └──Expression:
                                                    └──Type expr: Constructor: in_channel
                                                    └──Desc: Variable
                                                       └──Variable: ch |}]

let%expect_test "" =
  let str = 
    {|
      external print_int : int -> unit = "%print_int";;
      external print_newline : unit -> unit = "%print_newline";;
      external print_string : string -> unit = "%print_string";;
      external input_line : in_channel -> string = "%input_line";;

      external string_iter : (char -> unit) -> string -> unit = "%string_iter";;
      external string_length : string -> int = "%string_length";;

      exception End_of_file;;

      let incr = fun r -> r := !r + 1;;

      let read_stats = 
        fun ch ->
          let lines = ref 0 
          and chars = ref 0 
          and words = ref 0 
          and sentences = ref 0 in
          
          try 
            while true do
              let line = input_line ch in
              incr lines;
              chars := !chars + string_length line;
              string_iter
                (fun c ->
                  match c with
                  ( '.' -> incr sentences
                  | '?' -> incr sentences
                  | '!' -> incr sentences
                  | ' ' -> incr words
                  | _ -> ())
                )
                line
            done
          with
            (End_of_file ->
              print_string "There were ";
              print_int (!lines);
              print_string " lines, making up ";
              print_int (!chars);
              print_string " characters, with ";
              print_int (!words);
              print_string " words in ";
              print_int (!sentences);
              print_string "sentences.";
              print_newline ()
            )
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_int
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: int
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_int
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_newline
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: unit
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_newline
       └──Structure item: Primitive
          └──Value description:
             └──Name: print_string
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: unit
             └──Primitive name: %print_string
       └──Structure item: Primitive
          └──Value description:
             └──Name: input_line
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: in_channel
                   └──Type expr: Constructor: string
             └──Primitive name: %input_line
       └──Structure item: Primitive
          └──Value description:
             └──Name: string_iter
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Arrow
                      └──Type expr: Constructor: char
                      └──Type expr: Constructor: unit
                   └──Type expr: Arrow
                      └──Type expr: Constructor: string
                      └──Type expr: Constructor: unit
             └──Primitive name: %string_iter
       └──Structure item: Primitive
          └──Value description:
             └──Name: string_length
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: string
                   └──Type expr: Constructor: int
             └──Primitive name: %string_length
       └──Structure item: Exception
          └──Type exception:
             └──Extension constructor:
                └──Extension name: exn
                └──Extension parameters:
                └──Extension constructor kind: Declaration
                   └──Constructor declaration:
                      └──Constructor name: End_of_file
                      └──Constructor alphas:
                      └──Constructor type:
                         └──Type expr: Constructor: exn
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: ref
                         └──Type expr: Constructor: int
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: incr
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: ref
                            └──Type expr: Constructor: int
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: ref
                               └──Type expr: Constructor: int
                            └──Desc: Variable: r
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: int
                                     └──Type expr: Constructor: unit
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Type expr: Arrow
                                              └──Type expr: Constructor: int
                                              └──Type expr: Constructor: unit
                                        └──Desc: Primitive: (:=)
                                     └──Expression:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable
                                           └──Variable: r
                               └──Expression:
                                  └──Type expr: Constructor: int
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: int
                                           └──Type expr: Constructor: int
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: int
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: int
                                              └──Desc: Primitive: (+)
                                           └──Expression:
                                              └──Type expr: Constructor: int
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: ref
                                                          └──Type expr: Constructor: int
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Primitive: (!)
                                                 └──Expression:
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                    └──Desc: Variable
                                                       └──Variable: r
                                     └──Expression:
                                        └──Type expr: Constructor: int
                                        └──Desc: Constant: 1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: in_channel
                      └──Type expr: Constructor: unit
                   └──Desc: Variable: read_stats
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: in_channel
                         └──Type expr: Constructor: unit
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: in_channel
                            └──Desc: Variable: ch
                         └──Expression:
                            └──Type expr: Constructor: unit
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: lines
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 0
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: chars
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 0
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: words
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 0
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: ref
                                           └──Type expr: Constructor: int
                                        └──Desc: Variable: sentences
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: ref
                                              └──Type expr: Constructor: int
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: int
                                                    └──Type expr: Constructor: ref
                                                       └──Type expr: Constructor: int
                                                 └──Desc: Primitive: ref
                                              └──Expression:
                                                 └──Type expr: Constructor: int
                                                 └──Desc: Constant: 0
                               └──Expression:
                                  └──Type expr: Constructor: unit
                                  └──Desc: Try
                                     └──Expression:
                                        └──Type expr: Constructor: unit
                                        └──Desc: While
                                           └──Expression:
                                              └──Type expr: Constructor: bool
                                              └──Desc: Constant: true
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Let
                                                 └──Value bindings:
                                                    └──Value binding:
                                                       └──Pattern:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Variable: line
                                                       └──Abstraction:
                                                          └──Variables:
                                                          └──Expression:
                                                             └──Type expr: Constructor: string
                                                             └──Desc: Application
                                                                └──Expression:
                                                                   └──Type expr: Arrow
                                                                      └──Type expr: Constructor: in_channel
                                                                      └──Type expr: Constructor: string
                                                                   └──Desc: Variable
                                                                      └──Variable: input_line
                                                                └──Expression:
                                                                   └──Type expr: Constructor: in_channel
                                                                   └──Desc: Variable
                                                                      └──Variable: ch
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Sequence
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: ref
                                                                      └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: incr
                                                             └──Expression:
                                                                └──Type expr: Constructor: ref
                                                                   └──Type expr: Constructor: int
                                                                └──Desc: Variable
                                                                   └──Variable: lines
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Sequence
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: unit
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: ref
                                                                                  └──Type expr: Constructor: int
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Type expr: Constructor: unit
                                                                            └──Desc: Primitive: (:=)
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: ref
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Variable
                                                                               └──Variable: chars
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: int
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: int
                                                                                     └──Type expr: Arrow
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Type expr: Constructor: int
                                                                                  └──Desc: Primitive: (+)
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: int
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: ref
                                                                                              └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: int
                                                                                        └──Desc: Primitive: (!)
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: ref
                                                                                           └──Type expr: Constructor: int
                                                                                        └──Desc: Variable
                                                                                           └──Variable: chars
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: string
                                                                                     └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: string_length
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: string
                                                                                  └──Desc: Variable
                                                                                     └──Variable: line
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: string
                                                                         └──Type expr: Constructor: unit
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: char
                                                                                  └──Type expr: Constructor: unit
                                                                               └──Type expr: Arrow
                                                                                  └──Type expr: Constructor: string
                                                                                  └──Type expr: Constructor: unit
                                                                            └──Desc: Variable
                                                                               └──Variable: string_iter
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: char
                                                                               └──Type expr: Constructor: unit
                                                                            └──Desc: Function
                                                                               └──Pattern:
                                                                                  └──Type expr: Constructor: char
                                                                                  └──Desc: Variable: c
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: unit
                                                                                  └──Desc: Match
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: char
                                                                                        └──Desc: Variable
                                                                                           └──Variable: c
                                                                                     └──Type expr: Constructor: char
                                                                                     └──Cases:
                                                                                        └──Case:
                                                                                           └──Pattern:
                                                                                              └──Type expr: Constructor: char
                                                                                              └──Desc: Constant: .
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Application
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Constructor: ref
                                                                                                          └──Type expr: Constructor: int
                                                                                                       └──Type expr: Constructor: unit
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: incr
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: ref
                                                                                                       └──Type expr: Constructor: int
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: sentences
                                                                                        └──Case:
                                                                                           └──Pattern:
                                                                                              └──Type expr: Constructor: char
                                                                                              └──Desc: Constant: ?
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Application
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Constructor: ref
                                                                                                          └──Type expr: Constructor: int
                                                                                                       └──Type expr: Constructor: unit
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: incr
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: ref
                                                                                                       └──Type expr: Constructor: int
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: sentences
                                                                                        └──Case:
                                                                                           └──Pattern:
                                                                                              └──Type expr: Constructor: char
                                                                                              └──Desc: Constant: !
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Application
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Constructor: ref
                                                                                                          └──Type expr: Constructor: int
                                                                                                       └──Type expr: Constructor: unit
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: incr
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: ref
                                                                                                       └──Type expr: Constructor: int
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: sentences
                                                                                        └──Case:
                                                                                           └──Pattern:
                                                                                              └──Type expr: Constructor: char
                                                                                              └──Desc: Constant:
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Application
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Constructor: ref
                                                                                                          └──Type expr: Constructor: int
                                                                                                       └──Type expr: Constructor: unit
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: incr
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: ref
                                                                                                       └──Type expr: Constructor: int
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: words
                                                                                        └──Case:
                                                                                           └──Pattern:
                                                                                              └──Type expr: Constructor: char
                                                                                              └──Desc: Any
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Constant: ()
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: string
                                                                      └──Desc: Variable
                                                                         └──Variable: line
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: exn
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: End_of_file
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: exn
                                           └──Expression:
                                              └──Type expr: Constructor: unit
                                              └──Desc: Sequence
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: string
                                                             └──Type expr: Constructor: unit
                                                          └──Desc: Variable
                                                             └──Variable: print_string
                                                       └──Expression:
                                                          └──Type expr: Constructor: string
                                                          └──Desc: Constant: There were
                                                 └──Expression:
                                                    └──Type expr: Constructor: unit
                                                    └──Desc: Sequence
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: int
                                                                   └──Type expr: Constructor: unit
                                                                └──Desc: Variable
                                                                   └──Variable: print_int
                                                             └──Expression:
                                                                └──Type expr: Constructor: int
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: ref
                                                                            └──Type expr: Constructor: int
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Primitive: (!)
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: ref
                                                                         └──Type expr: Constructor: int
                                                                      └──Desc: Variable
                                                                         └──Variable: lines
                                                       └──Expression:
                                                          └──Type expr: Constructor: unit
                                                          └──Desc: Sequence
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: string
                                                                         └──Type expr: Constructor: unit
                                                                      └──Desc: Variable
                                                                         └──Variable: print_string
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: string
                                                                      └──Desc: Constant:  lines, making up
                                                             └──Expression:
                                                                └──Type expr: Constructor: unit
                                                                └──Desc: Sequence
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: unit
                                                                      └──Desc: Application
                                                                         └──Expression:
                                                                            └──Type expr: Arrow
                                                                               └──Type expr: Constructor: int
                                                                               └──Type expr: Constructor: unit
                                                                            └──Desc: Variable
                                                                               └──Variable: print_int
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: int
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: ref
                                                                                        └──Type expr: Constructor: int
                                                                                     └──Type expr: Constructor: int
                                                                                  └──Desc: Primitive: (!)
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: ref
                                                                                     └──Type expr: Constructor: int
                                                                                  └──Desc: Variable
                                                                                     └──Variable: chars
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: unit
                                                                      └──Desc: Sequence
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: unit
                                                                            └──Desc: Application
                                                                               └──Expression:
                                                                                  └──Type expr: Arrow
                                                                                     └──Type expr: Constructor: string
                                                                                     └──Type expr: Constructor: unit
                                                                                  └──Desc: Variable
                                                                                     └──Variable: print_string
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: string
                                                                                  └──Desc: Constant:  characters, with
                                                                         └──Expression:
                                                                            └──Type expr: Constructor: unit
                                                                            └──Desc: Sequence
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: unit
                                                                                  └──Desc: Application
                                                                                     └──Expression:
                                                                                        └──Type expr: Arrow
                                                                                           └──Type expr: Constructor: int
                                                                                           └──Type expr: Constructor: unit
                                                                                        └──Desc: Variable
                                                                                           └──Variable: print_int
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: int
                                                                                        └──Desc: Application
                                                                                           └──Expression:
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: ref
                                                                                                    └──Type expr: Constructor: int
                                                                                                 └──Type expr: Constructor: int
                                                                                              └──Desc: Primitive: (!)
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: ref
                                                                                                 └──Type expr: Constructor: int
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: words
                                                                               └──Expression:
                                                                                  └──Type expr: Constructor: unit
                                                                                  └──Desc: Sequence
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: unit
                                                                                        └──Desc: Application
                                                                                           └──Expression:
                                                                                              └──Type expr: Arrow
                                                                                                 └──Type expr: Constructor: string
                                                                                                 └──Type expr: Constructor: unit
                                                                                              └──Desc: Variable
                                                                                                 └──Variable: print_string
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: string
                                                                                              └──Desc: Constant:  words in
                                                                                     └──Expression:
                                                                                        └──Type expr: Constructor: unit
                                                                                        └──Desc: Sequence
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Application
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Arrow
                                                                                                       └──Type expr: Constructor: int
                                                                                                       └──Type expr: Constructor: unit
                                                                                                    └──Desc: Variable
                                                                                                       └──Variable: print_int
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: int
                                                                                                    └──Desc: Application
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Arrow
                                                                                                             └──Type expr: Constructor: ref
                                                                                                                └──Type expr: Constructor: int
                                                                                                             └──Type expr: Constructor: int
                                                                                                          └──Desc: Primitive: (!)
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Constructor: ref
                                                                                                             └──Type expr: Constructor: int
                                                                                                          └──Desc: Variable
                                                                                                             └──Variable: sentences
                                                                                           └──Expression:
                                                                                              └──Type expr: Constructor: unit
                                                                                              └──Desc: Sequence
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: unit
                                                                                                    └──Desc: Application
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Arrow
                                                                                                             └──Type expr: Constructor: string
                                                                                                             └──Type expr: Constructor: unit
                                                                                                          └──Desc: Variable
                                                                                                             └──Variable: print_string
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Constructor: string
                                                                                                          └──Desc: Constant: sentences.
                                                                                                 └──Expression:
                                                                                                    └──Type expr: Constructor: unit
                                                                                                    └──Desc: Application
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Arrow
                                                                                                             └──Type expr: Constructor: unit
                                                                                                             └──Type expr: Constructor: unit
                                                                                                          └──Desc: Variable
                                                                                                             └──Variable: print_newline
                                                                                                       └──Expression:
                                                                                                          └──Type expr: Constructor: unit
                                                                                                          └──Desc: Constant: () |}]

let%expect_test "" =
  let str = 
    {|
      external add : float -> float -> float = "%add_float";;
      external sub : float -> float -> float = "%sub_float";;
      external mul : float -> float -> float = "%mul_float";;
      external div : float -> float -> float = "%div_float";;
      external sqrt : float -> float = "%sqrt";;

      type vector = float * float;;

      let create_vector = 
        fun (x0, y0) (x1, y1) ->
          (sub x1 x0, sub y1 y0)
      ;;

      let length = 
        fun (dx, dy) ->
          sqrt (add (mul dx dx) (mul dy dy))
      ;;

      let add = 
        fun (x0, y0) (x1, y1) ->
          (add x0 x1, add y0 y1)
      ;;

      let scale_mul = 
        fun x (dx, dy) ->
          (mul x dx, mul x dy)
      ;;

      type 'a option = 
        | None
        | Some of 'a
      ;;

      external eq : 'a. 'a -> 'a -> bool = "%equal";;

      let normalize = 
        fun vec ->
          let length = length vec in
          if eq length 0.0 then None
          else Some (scale_mul (div 1.0 length) vec)
      ;; 

      let map = 
        fun t f ->
          match t with
          ( None -> None
          | Some x -> Some (f x)
          )
      ;;

      let set_length = 
        fun len vec ->
          map (normalize vec) (fun vec -> scale_mul len vec)
      ;;
    |}
  in
  print_infer_result str;
  [%expect {|
    Structure:
    └──Structure:
       └──Structure item: Primitive
          └──Value description:
             └──Name: add
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: float
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
             └──Primitive name: %add_float
       └──Structure item: Primitive
          └──Value description:
             └──Name: sub
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: float
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
             └──Primitive name: %sub_float
       └──Structure item: Primitive
          └──Value description:
             └──Name: mul
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: float
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
             └──Primitive name: %mul_float
       └──Structure item: Primitive
          └──Value description:
             └──Name: div
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: float
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
             └──Primitive name: %div_float
       └──Structure item: Primitive
          └──Value description:
             └──Name: sqrt
             └──Scheme:
                └──Variables:
                └──Type expr: Arrow
                   └──Type expr: Constructor: float
                   └──Type expr: Constructor: float
             └──Primitive name: %sqrt
       └──Structure item: Type
          └──Type declaration:
             └──Type name: vector
             └──Type declaration kind: Alias
                └──Alias
                   └──Alias name: vector
                   └──Alias alphas:
                   └──Type expr: Tuple
                      └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Constructor: float
                         └──Type expr: Constructor: float
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                   └──Desc: Variable: create_vector
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Desc: Tuple
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: x0
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: y0
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: x1
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: y1
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: sub
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: x1
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: x0
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: sub
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: y1
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: y0
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Constructor: float
                         └──Type expr: Constructor: float
                      └──Type expr: Constructor: float
                   └──Desc: Variable: length
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Desc: Tuple
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: dx
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: dy
                         └──Expression:
                            └──Type expr: Constructor: float
                            └──Desc: Application
                               └──Expression:
                                  └──Type expr: Arrow
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Variable
                                     └──Variable: sqrt
                               └──Expression:
                                  └──Type expr: Constructor: float
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Constructor: float
                                           └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Arrow
                                                    └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: add
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: float
                                                             └──Type expr: Arrow
                                                                └──Type expr: Constructor: float
                                                                └──Type expr: Constructor: float
                                                          └──Desc: Variable
                                                             └──Variable: mul
                                                       └──Expression:
                                                          └──Type expr: Constructor: float
                                                          └──Desc: Variable
                                                             └──Variable: dx
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: dx
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: mul
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: dy
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: dy
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Constructor: float
                         └──Type expr: Constructor: float
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                   └──Desc: Variable: add
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Desc: Tuple
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: x0
                               └──Pattern:
                                  └──Type expr: Constructor: float
                                  └──Desc: Variable: y0
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: x1
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: y1
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: add
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: x0
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: x1
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: add
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: y0
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: y1
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                   └──Desc: Variable: scale_mul
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: float
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: float
                            └──Desc: Variable: x
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: dx
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: dy
                               └──Expression:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Tuple
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: mul
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: dx
                                     └──Expression:
                                        └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: mul
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: dy
       └──Structure item: Type
          └──Type declaration:
             └──Type name: option
             └──Type declaration kind: Variant
                └──Constructor declaration:
                   └──Constructor name: None
                   └──Constructor alphas: 7039
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 7039
                └──Constructor declaration:
                   └──Constructor name: Some
                   └──Constructor alphas: 7039
                   └──Constructor type:
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 7039
                   └──Constructor argument:
                      └──Constructor betas:
                      └──Type expr: Variable: 7039
       └──Structure item: Primitive
          └──Value description:
             └──Name: eq
             └──Scheme:
                └──Variables: 7261
                └──Type expr: Arrow
                   └──Type expr: Variable: 7261
                   └──Type expr: Arrow
                      └──Type expr: Variable: 7261
                      └──Type expr: Constructor: bool
             └──Primitive name: %equal
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Tuple
                         └──Type expr: Constructor: float
                         └──Type expr: Constructor: float
                      └──Type expr: Constructor: option
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                   └──Desc: Variable: normalize
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Constructor: option
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Desc: Variable: vec
                         └──Expression:
                            └──Type expr: Constructor: option
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                            └──Desc: Let
                               └──Value bindings:
                                  └──Value binding:
                                     └──Pattern:
                                        └──Type expr: Constructor: float
                                        └──Desc: Variable: length
                                     └──Abstraction:
                                        └──Variables:
                                        └──Expression:
                                           └──Type expr: Constructor: float
                                           └──Desc: Application
                                              └──Expression:
                                                 └──Type expr: Arrow
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                                 └──Desc: Variable
                                                    └──Variable: length
                                              └──Expression:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                                 └──Desc: Variable
                                                    └──Variable: vec
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: float
                                        └──Type expr: Constructor: float
                                  └──Desc: If
                                     └──Expression:
                                        └──Type expr: Constructor: bool
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: bool
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Arrow
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: bool
                                                    └──Desc: Variable
                                                       └──Variable: eq
                                                       └──Type expr: Constructor: float
                                                 └──Expression:
                                                    └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: length
                                           └──Expression:
                                              └──Type expr: Constructor: float
                                              └──Desc: Constant: 0.000000
                                     └──Expression:
                                        └──Type expr: Constructor: option
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: float
                                              └──Type expr: Constructor: float
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: None
                                              └──Constructor type:
                                                 └──Type expr: Constructor: option
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                     └──Expression:
                                        └──Type expr: Constructor: option
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: float
                                              └──Type expr: Constructor: float
                                        └──Desc: Construct
                                           └──Constructor description:
                                              └──Name: Some
                                              └──Constructor argument type:
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                              └──Constructor type:
                                                 └──Type expr: Constructor: option
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: float
                                                             └──Type expr: Arrow
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: float
                                                                   └──Type expr: Constructor: float
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: float
                                                                   └──Type expr: Constructor: float
                                                          └──Desc: Variable
                                                             └──Variable: scale_mul
                                                       └──Expression:
                                                          └──Type expr: Constructor: float
                                                          └──Desc: Application
                                                             └──Expression:
                                                                └──Type expr: Arrow
                                                                   └──Type expr: Constructor: float
                                                                   └──Type expr: Constructor: float
                                                                └──Desc: Application
                                                                   └──Expression:
                                                                      └──Type expr: Arrow
                                                                         └──Type expr: Constructor: float
                                                                         └──Type expr: Arrow
                                                                            └──Type expr: Constructor: float
                                                                            └──Type expr: Constructor: float
                                                                      └──Desc: Variable
                                                                         └──Variable: div
                                                                   └──Expression:
                                                                      └──Type expr: Constructor: float
                                                                      └──Desc: Constant: 1.000000
                                                             └──Expression:
                                                                └──Type expr: Constructor: float
                                                                └──Desc: Variable
                                                                   └──Variable: length
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: vec
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: option
                         └──Type expr: Variable: 7352
                      └──Type expr: Arrow
                         └──Type expr: Arrow
                            └──Type expr: Variable: 7352
                            └──Type expr: Variable: 7349
                         └──Type expr: Constructor: option
                            └──Type expr: Variable: 7349
                   └──Desc: Variable: map
                └──Abstraction:
                   └──Variables: 7352,7352,7352
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: option
                            └──Type expr: Variable: 7352
                         └──Type expr: Arrow
                            └──Type expr: Arrow
                               └──Type expr: Variable: 7352
                               └──Type expr: Variable: 7349
                            └──Type expr: Constructor: option
                               └──Type expr: Variable: 7349
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: option
                               └──Type expr: Variable: 7352
                            └──Desc: Variable: t
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Arrow
                                  └──Type expr: Variable: 7352
                                  └──Type expr: Variable: 7349
                               └──Type expr: Constructor: option
                                  └──Type expr: Variable: 7349
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Arrow
                                     └──Type expr: Variable: 7352
                                     └──Type expr: Variable: 7349
                                  └──Desc: Variable: f
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Variable: 7349
                                  └──Desc: Match
                                     └──Expression:
                                        └──Type expr: Constructor: option
                                           └──Type expr: Variable: 7352
                                        └──Desc: Variable
                                           └──Variable: t
                                     └──Type expr: Constructor: option
                                        └──Type expr: Variable: 7352
                                     └──Cases:
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 7352
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: None
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 7352
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 7349
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: None
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 7349
                                        └──Case:
                                           └──Pattern:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 7352
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Some
                                                    └──Constructor argument type:
                                                       └──Type expr: Variable: 7352
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 7352
                                                 └──Pattern:
                                                    └──Type expr: Variable: 7352
                                                    └──Desc: Variable: x
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Variable: 7349
                                              └──Desc: Construct
                                                 └──Constructor description:
                                                    └──Name: Some
                                                    └──Constructor argument type:
                                                       └──Type expr: Variable: 7349
                                                    └──Constructor type:
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Variable: 7349
                                                 └──Expression:
                                                    └──Type expr: Variable: 7349
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Variable: 7352
                                                             └──Type expr: Variable: 7349
                                                          └──Desc: Variable
                                                             └──Variable: f
                                                       └──Expression:
                                                          └──Type expr: Variable: 7352
                                                          └──Desc: Variable
                                                             └──Variable: x
       └──Structure item: Let
          └──Value bindings:
             └──Value binding:
                └──Pattern:
                   └──Type expr: Arrow
                      └──Type expr: Constructor: float
                      └──Type expr: Arrow
                         └──Type expr: Tuple
                            └──Type expr: Constructor: float
                            └──Type expr: Constructor: float
                         └──Type expr: Constructor: option
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                   └──Desc: Variable: set_length
                └──Abstraction:
                   └──Variables:
                   └──Expression:
                      └──Type expr: Arrow
                         └──Type expr: Constructor: float
                         └──Type expr: Arrow
                            └──Type expr: Tuple
                               └──Type expr: Constructor: float
                               └──Type expr: Constructor: float
                            └──Type expr: Constructor: option
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                      └──Desc: Function
                         └──Pattern:
                            └──Type expr: Constructor: float
                            └──Desc: Variable: len
                         └──Expression:
                            └──Type expr: Arrow
                               └──Type expr: Tuple
                                  └──Type expr: Constructor: float
                                  └──Type expr: Constructor: float
                               └──Type expr: Constructor: option
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                            └──Desc: Function
                               └──Pattern:
                                  └──Type expr: Tuple
                                     └──Type expr: Constructor: float
                                     └──Type expr: Constructor: float
                                  └──Desc: Variable: vec
                               └──Expression:
                                  └──Type expr: Constructor: option
                                     └──Type expr: Tuple
                                        └──Type expr: Constructor: float
                                        └──Type expr: Constructor: float
                                  └──Desc: Application
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Arrow
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                           └──Type expr: Constructor: option
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                        └──Desc: Application
                                           └──Expression:
                                              └──Type expr: Arrow
                                                 └──Type expr: Constructor: option
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                 └──Type expr: Arrow
                                                    └──Type expr: Arrow
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: option
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                              └──Desc: Variable
                                                 └──Variable: map
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                           └──Expression:
                                              └──Type expr: Constructor: option
                                                 └──Type expr: Tuple
                                                    └──Type expr: Constructor: float
                                                    └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: option
                                                          └──Type expr: Tuple
                                                             └──Type expr: Constructor: float
                                                             └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: normalize
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: vec
                                     └──Expression:
                                        └──Type expr: Arrow
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: float
                                              └──Type expr: Constructor: float
                                           └──Type expr: Tuple
                                              └──Type expr: Constructor: float
                                              └──Type expr: Constructor: float
                                        └──Desc: Function
                                           └──Pattern:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Variable: vec
                                           └──Expression:
                                              └──Type expr: Tuple
                                                 └──Type expr: Constructor: float
                                                 └──Type expr: Constructor: float
                                              └──Desc: Application
                                                 └──Expression:
                                                    └──Type expr: Arrow
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                       └──Type expr: Tuple
                                                          └──Type expr: Constructor: float
                                                          └──Type expr: Constructor: float
                                                    └──Desc: Application
                                                       └──Expression:
                                                          └──Type expr: Arrow
                                                             └──Type expr: Constructor: float
                                                             └──Type expr: Arrow
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: float
                                                                   └──Type expr: Constructor: float
                                                                └──Type expr: Tuple
                                                                   └──Type expr: Constructor: float
                                                                   └──Type expr: Constructor: float
                                                          └──Desc: Variable
                                                             └──Variable: scale_mul
                                                       └──Expression:
                                                          └──Type expr: Constructor: float
                                                          └──Desc: Variable
                                                             └──Variable: len
                                                 └──Expression:
                                                    └──Type expr: Tuple
                                                       └──Type expr: Constructor: float
                                                       └──Type expr: Constructor: float
                                                    └──Desc: Variable
                                                       └──Variable: vec |}]